<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heme-Lymph Match</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .animate-shake {
            animation: shake 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fadeIn {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-popIn {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* Pulse for selections */
        .selected-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        /* Flowchart Specific Styles */
        .flowchart-container {
            cursor: grab;
            transform-origin: top left;
            transition: transform 0.1s ease-out;
        }
        .flowchart-container:active {
            cursor: grabbing;
        }
        
        /* Custom Scrollbar for nicer look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- HEADER (Fixed at top) -->
    <header class="bg-white border-b border-slate-200 shadow-sm z-30 flex-none h-16">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <!-- BookOpen Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                </div>
                <h1 class="font-bold text-xl hidden sm:block">Heme-Lymph Match</h1>
                <h1 class="font-bold text-xl sm:hidden">HL Match</h1>
            </div>

            <!-- Header Controls -->
            <div id="header-controls" class="flex items-center gap-2 sm:gap-4 text-sm font-semibold">
                
                <!-- Flowchart Controls -->
                <div id="flowchart-controls" class="hidden flex items-center gap-1">
                    <button onclick="adjustZoom(-0.1)" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
                    <button onclick="resetZoom()" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg></button>
                    <button onclick="adjustZoom(0.1)" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
                </div>

                <!-- Score Stats -->
                <div id="game-stats" class="hidden flex items-center gap-4">
                    <div class="flex items-center gap-2 text-slate-500">
                        <span id="progress-display" class="bg-slate-100 px-2 py-1 rounded text-slate-700">0 / 0</span>
                    </div>
                    <div class="flex items-center gap-2 text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                        <span id="score-display">0</span>
                    </div>
                </div>

                <!-- Close Button -->
                <button id="close-btn" onclick="goToMenu()" class="hidden text-slate-400 hover:text-slate-600 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT AREA (Scrollable) -->
    <main id="main-content" class="w-full flex-grow relative overflow-y-auto bg-slate-100">
        <!-- Content injected by JS -->
    </main>

    <!-- IMAGE MODAL -->
    <div id="image-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-fadeIn" onclick="closeImageModal()">
        <div class="relative bg-transparent max-w-5xl w-full max-h-full flex flex-col items-center justify-center" onclick="event.stopPropagation()">
            <img id="modal-img" src="" alt="Full size" class="max-w-full max-h-[80vh] rounded-lg shadow-2xl object-contain border-2 border-white/20">
            <div class="bg-black/70 backdrop-blur-md text-white mt-4 px-6 py-4 rounded-xl text-center max-w-2xl border border-white/10">
                <h3 id="modal-title" class="text-xl font-bold mb-1 text-white"></h3>
                <p id="modal-caption" class="text-slate-300 text-sm leading-relaxed"></p>
            </div>
            <button onclick="closeImageModal()" class="absolute -top-12 right-0 text-white/70 hover:text-white p-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
    </div>

    <script>
        // --- ICONS ---
        const ICONS = {
            Layers: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>`,
            Droplet: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></svg>`,
            Activity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
            ShieldAlert: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>`,
            Bug: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>`,
            FlaskConical: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>`,
            Pill: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg>`,
            CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>`,
            ArrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>`,
            TrophyBig: `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            RotateCcw: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>`,
            GitBranch: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>`,
            Sparkles: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>`,
            Stethoscope: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></svg>`,
            Microscope: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/><path d="M12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3"/></svg>`,
            Eye: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`,
            EyeOff: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" y1="2" x2="22" y2="22"/></svg>`,
            Image: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>`
        };

        // --- MATCHING GAME DATA ---
        // Expanded with data from Hematologic_Disorders_ALL_21.xlsx AND new lab text
        const FULL_DATA = [
            // --- HEME SYNTHESIS DISORDERS ---
            { category: 'Heme Synthesis', term: 'Acute Intermittent Porphyria (AIP)', def: 'AD, ↓ Porphobilinogen deaminase. Pain, Psych, Neuro, Port-wine urine. ↑ ALA/PBG.' },
            { category: 'Heme Synthesis', term: 'Porphyria Cutanea Tarda (PCT)', def: '↓ Uroporphyrinogen decarboxylase. Photosensitivity, Blisters, Red-brown urine. ↑ Uroporphyrins.' },
            { category: 'Heme Synthesis', term: 'Lead Poisoning', def: 'Inhibits ALA dehydratase & Ferrochelatase. Basophilic stippling, Ringed Sideroblasts. Encephalopathy.' },

            // --- HYPOPROLIFERATIVE ANEMIAS ---
            { category: 'Anemias: Hypoproliferative', term: 'Iron Deficiency Anemia (IDA)', def: 'Microcytic. ↓ Ferritin, ↓ Iron, ↑ TIBC. Pica, Spoon nails. Pencil cells.' },
            { category: 'Anemias: Hypoproliferative', term: 'Anemia of Chronic Disease (ACD)', def: 'Normo/Microcytic. ↑ Hepcidin sequestering iron. ↑ Ferritin, ↓ Iron, ↓ TIBC.' },
            { category: 'Anemias: Hypoproliferative', term: 'Thalassemia', def: 'Microcytic. Globin chain defect. Target cells. Normal Iron/Ferritin. ↑ HbA2/HbF (Beta).' },
            { category: 'Anemias: Hypoproliferative', term: 'Sideroblastic Anemia', def: 'Microcytic. Heme synthesis defect (ALAS2). Ringed Sideroblasts. ↑ Iron, ↑ Ferritin.' },
            { category: 'Anemias: Hypoproliferative', term: 'Anemia of Chronic Kidney Disease (CKD)', def: 'Normocytic. ↓ EPO production. Low Reticulocytes. Burrs cells (Echinocytes) if uremic.' },
            { category: 'Anemias: Hypoproliferative', term: 'B12 Deficiency', def: 'Macrocytic. ↑ MMA & Homocysteine. Neuro symptoms. Hypersegmented Neutrophils.' },
            { category: 'Anemias: Hypoproliferative', term: 'Folate Deficiency', def: 'Macrocytic. Normal MMA, ↑ Homocysteine. No neuro symptoms. Hypersegmented Neutrophils.' },
            { category: 'Anemias: Hypoproliferative', term: 'Copper Deficiency', def: 'Macrocytic/Microcytic + Neutropenia. Mimics MDS. Low Ceruloplasmin.' },

            // --- HEMOLYTIC ANEMIAS (Non-MAHA) ---
            { category: 'Hemolytic (Non-MAHA)', term: 'Sickle Cell Disease (SCD)', def: 'HbS polymerization (Glu->Val). Pain crises, ACS. Sickle cells, Target cells. ↑ Retic.' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Warm Autoimmune Hemolytic Anemia (AIHA)', def: 'IgG (Warm). Splenic macrophage destruction. Spherocytes. +Coombs (IgG). SLE/Drugs.' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Cold Autoimmune Hemolytic Anemia (AIHA)', def: 'IgM (Cold). Complement fixation. Agglutination on smear. +Coombs (C3). Mycoplasma/Mono.' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Hereditary Spherocytosis', def: 'Cytoskeleton defect (Spectrin/Ankyrin). Spherocytes. ↑ MCHC. +Osmotic Fragility.' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Glucose-6-Phosphate Dehydrogenase Deficiency (G6PD)', def: 'X-linked. Oxidative stress -> Hemolysis. Heinz bodies -> Bite cells. Fava beans/Sulfa.' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Paroxysmal Nocturnal Hemoglobinuria (PNH)', def: 'Acquired PIG-A mutation. Loss of CD55/59 (GPI anchors). Dark urine (AM), Thrombosis.' },
            { category: 'Hemolytic (Non-MAHA)', term: 'Pyruvate Kinase Deficiency', def: '↓ ATP -> RBC rigidity. Extravascular hemolysis. Echinocytes. Newborn jaundice.' },

            // --- MAHA (Microangiopathic Hemolytic Anemias) ---
            { category: 'MAHAs', term: 'Thrombotic Thrombocytopenic Purpura (TTP)', def: '↓ ADAMTS13. Pentad: Fever, Neuro, Renal, MAHA, ↓ Platelets. Schistocytes.' },
            { category: 'MAHAs', term: 'Hemolytic Uremic Syndrome (HUS)', def: 'Shiga-toxin E. coli (O157:H7). Renal failure dominant. Bloody diarrhea. Schistocytes.' },
            { category: 'MAHAs', term: 'Disseminated Intravascular Coagulation (DIC)', def: 'Systemic activation. Consumptive coagulopathy. Bleeding + Clotting. ↑ PT/PTT, ↑ D-Dimer.' },
            { category: 'MAHAs', term: 'HELLP Syndrome', def: 'Pregnancy complication. Hemolysis, Elevated Liver enzymes, Low Platelets. Schistocytes.' },

            // --- BONE MARROW FAILURE ---
            { category: 'Bone Marrow Failure', term: 'Aplastic Anemia', def: 'Pancytopenia. Hypocellular (fatty) marrow. Causes: Radiation, Viruses, Drugs.' },
            { category: 'Bone Marrow Failure', term: 'Pure Red Cell Aplasia (PRCA)', def: 'Anemia with low retics. Normal WBC/Plt. Associated with Parvovirus B19, Thymoma.' },
            { category: 'Bone Marrow Failure', term: 'Fanconi Anemia', def: 'Inherited DNA repair defect. Pancytopenia, Short stature, Thumb abnormalities.' },
            { category: 'Bone Marrow Failure', term: 'Diamond-Blackfan Anemia', def: 'Congenital PRCA. Ribosomal defect. Macrocytic anemia, Craniofacial abnormalities.' },

            // --- COAGULATION & PLATELETS ---
            { category: 'Coagulation & Platelets', term: 'Hemophilia A', def: 'Factor VIII deficiency. X-linked. Hemarthrosis. ↑ PTT. Mixing study corrects.' },
            { category: 'Coagulation & Platelets', term: 'Hemophilia B', def: 'Factor IX deficiency. X-linked. Clinically identical to A. ↑ PTT.' },
            { category: 'Coagulation & Platelets', term: 'Von Willebrand Disease (vWD)', def: 'AD. Defect in adhesion & F8 carrier. Mucosal bleeding. ↑ Bleeding Time/PFA.' },
            { category: 'Coagulation & Platelets', term: 'Vitamin K Deficiency', def: '↓ Factors II, VII, IX, X, C, S. ↑ PT (early) and ↑ PTT. Warfarin/Malabsorption.' },
            { category: 'Coagulation & Platelets', term: 'Immune Thrombocytopenia (ITP)', def: 'Anti-GpIIb/IIIa antibodies. Isolated ↓ Platelets. Megakaryocytes in marrow.' },
            { category: 'Coagulation & Platelets', term: 'Bernard-Soulier Syndrome', def: 'GpIb deficiency (Adhesion). Giant Platelets. ↓ Platelets. No Ristocetin aggregation.' },
            { category: 'Coagulation & Platelets', term: 'Glanzmann Thrombasthenia', def: 'GpIIb/IIIa deficiency (Aggregation). Normal Platelet count. No aggregation with agonists.' },
            { category: 'Coagulation & Platelets', term: 'Factor V Leiden', def: 'Factor V resistant to Protein C cleavage. Hypercoagulable state. DVT/PE.' },
            { category: 'Coagulation & Platelets', term: 'Antiphospholipid Syndrome (APS)', def: 'Lupus anticoagulant. Hypercoagulable but ↑ PTT (paradoxical). Recurrent miscarriages.' },
            { category: 'Coagulation & Platelets', term: 'Heparin Induced Thrombocytopenia (HIT)', def: 'Antibodies to PF4-Heparin. Thrombosis + ↓ Platelets (50% drop). Stop Heparin.' },

            // --- FOUNDATIONS: LABS ---
            { category: 'Foundations: Labs', term: 'Hemoglobin (Hb/Hgb)', def: 'Direct measure of O2-carrying protein. Low = Anemia, High = Polycythemia.' },
            { category: 'Foundations: Labs', term: 'Hematocrit (Hct)', def: 'Volume % of RBCs. Low = Anemia/Hemodilution. High = Polycythemia/Dehydration.' },
            { category: 'Foundations: Labs', term: 'Red Blood Cell Count (RBC)', def: 'Number of red cells. High count with low MCV suggests Thalassemia Trait.' },
            { category: 'Foundations: Labs', term: 'Mean Corpuscular Volume (MCV)', def: 'Avg RBC size. Microcytic (<80), Normocytic (80-100), Macrocytic (>100).' },
            { category: 'Foundations: Labs', term: 'Mean Corpuscular Hemoglobin (MCH)', def: 'Avg Hb weight per RBC. Low = Hypochromia (Pale cells).' },
            { category: 'Foundations: Labs', term: 'Mean Corpuscular Hemoglobin Concentration (MCHC)', def: 'Avg Hb concentration. High = Hereditary Spherocytosis (Hyperchromic).' },
            { category: 'Foundations: Labs', term: 'Red Cell Distribution Width (RDW)', def: 'Measures anisocytosis. High in Iron Deficiency/Megaloblastic. Normal in Thalassemia Trait.' },
            
            { category: 'Foundations: Labs', term: 'Reticulocyte Count', def: '% of immature RBCs with residual RNA. Measures marrow output.' },
            { category: 'Foundations: Labs', term: 'Reticulocyte Index (RI)', def: '>2 = Hyperproliferative (Hemolysis/Blood Loss). <2 = Hypoproliferative (Production problem).' },

            { category: 'Foundations: Labs', term: 'Serum Ferritin', def: 'Stored iron. Low = Iron Deficiency (Diagnostic). High = Chronic Disease/Sideroblastic.' },
            { category: 'Foundations: Labs', term: 'Serum Iron', def: 'Circulating iron. Low in IDA/ACD. High in Sideroblastic.' },
            { category: 'Foundations: Labs', term: 'Total Iron Binding Capacity (TIBC)', def: 'Measure of Transferrin. High in Iron Deficiency. Low in Chronic Disease.' },
            { category: 'Foundations: Labs', term: 'Transferrin Saturation', def: '% binding sites occupied. Low in IDA. High in Sideroblastic.' },
            { category: 'Foundations: Labs', term: 'Soluble Transferrin Receptor (sTfR)', def: 'High in Iron Deficiency (cells hungry for iron). Normal in ACD.' },
            { category: 'Foundations: Labs', term: 'Zinc Protoporphyrin (ZPP)', def: 'Zinc used instead of iron in heme. High in IDA and Lead Poisoning.' },

            { category: 'Foundations: Labs', term: 'Serum B12 (Cobalamin)', def: 'Low in Pernicious Anemia, dietary deficiency.' },
            { category: 'Foundations: Labs', term: 'Serum Folate', def: 'Low in dietary deficiency, alcoholism.' },
            { category: 'Foundations: Labs', term: 'Methylmalonic Acid (MMA)', def: 'High in B12 Deficiency. Normal in Folate Deficiency. Differentiates the two.' },
            { category: 'Foundations: Labs', term: 'Homocysteine', def: 'High in BOTH B12 and Folate deficiencies.' },
            { category: 'Foundations: Labs', term: 'Serum Copper', def: 'Low levels mimic B12 deficiency (Macrocytic + Neuro symptoms).' },
            { category: 'Foundations: Labs', term: 'Anti-Intrinsic Factor / Parietal Cell Abs', def: 'Positive = Pernicious Anemia.' },

            { category: 'Foundations: Labs', term: 'Serum Haptoglobin', def: 'Binds free Hb. Decreased in Hemolysis.' },
            { category: 'Foundations: Labs', term: 'Lactate Dehydrogenase (LDH)', def: 'Intracellular enzyme. Increased in Hemolysis and cell turnover.' },
            { category: 'Foundations: Labs', term: 'Indirect Bilirubin', def: 'Unconjugated. Increased in Hemolysis.' },
            { category: 'Foundations: Labs', term: 'Direct Antiglobulin Test (Coombs)', def: 'Detects Abs/Complement on RBCs. Positive in Autoimmune Hemolysis.' },
            { category: 'Foundations: Labs', term: 'Osmotic Fragility Test', def: 'RBC lysis in hypotonic saline. Increased in Hereditary Spherocytosis.' },
            { category: 'Foundations: Labs', term: 'G6PD Assay', def: 'Enzyme activity. Low in G6PD deficiency (Check after acute episode).' },
            { category: 'Foundations: Labs', term: 'Hemoglobin Electrophoresis', def: 'Separates Hb types. Diagnoses Thalassemia and Sickle Cell.' },
            { category: 'Foundations: Labs', term: 'Carboxyhemoglobin', def: 'Measures Hemoglobin bound to Carbon Monoxide. Diagnosis of CO poisoning.' },
            { category: 'Foundations: Labs', term: 'Flow Cytometry (CD55/59)', def: 'Detects GPI anchors. Absent in PNH.' },

            { category: 'Foundations: Labs', term: 'ABO/Rh Typing', def: 'Forward (Antigens) and Back (Antibodies) type for compatibility.' },
            { category: 'Foundations: Labs', term: 'Antibody Screen', def: 'Detects alloantibodies. Prevents Delayed Hemolytic Reactions.' },
            { category: 'Foundations: Labs', term: 'HLA Antibody Testing', def: 'Tested in female donors (pregnancy history) to prevent TRALI.' },
            { category: 'Foundations: Labs', term: 'BNP (B-type Natriuretic Peptide)', def: 'Heart strain marker. High in TACO (Overload), Low in TRALI.' },
            { category: 'Foundations: Labs', term: 'PT (Prothrombin Time)', def: 'Extrinsic pathway. Monitor Warfarin. Prolonged = need Plasma (FFP)?' },
            { category: 'Foundations: Labs', term: 'aPTT (Activated Partial Thromboplastin Time)', def: 'Measures Intrinsic (XII, XI, IX, VIII) + Common. Heparin monitoring.' },
            { category: 'Foundations: Labs', term: 'Mixing Study', def: 'Corrects = Factor Deficiency. No Correction = Inhibitor.' },
            { category: 'Foundations: Labs', term: 'Fibrinogen Level', def: 'Low (<100) is indication for Cryoprecipitate transfusion.' },
            { category: 'Foundations: Labs', term: 'D-Dimer', def: 'Fibrin degradation product. Sensitive for DIC, DVT, PE.' },
            { category: 'Foundations: Labs', term: 'Bleeding Time / PFA (Platelet Function Assay)', def: 'Measures Platelet function (Primary Hemostasis).' },
            { category: 'Foundations: Labs', term: 'Ristocetin Cofactor Assay', def: 'Tests vWF function. Agglutinates platelets if vWF and GpIb are normal.' },
            { category: 'Foundations: Labs', term: 'Platelet Bacterial Culture', def: 'Prevent sepsis. Platelets are stored at room temp (high risk).' },

            { category: 'Foundations: Labs', term: 'Parvovirus B19 PCR', def: 'Positive in PRCA / Aplastic Crisis. "Giant Pronormoblasts".' },
            { category: 'Foundations: Labs', term: 'Bone Marrow Biopsy', def: 'Fatty (Aplastic), Ringed Sideroblasts (Sideroblastic), Giant Pronormoblasts (Parvo), Absent Iron (IDA).' },
            { category: 'Foundations: Labs', term: 'Lead Level', def: 'High in Lead Poisoning (Acquired Sideroblastic Anemia).' },
            { category: 'Foundations: Labs', term: 'HIV Serology', def: 'Detects HIV antibodies. Causes pancytopenia/immune dysregulation.' },
            { category: 'Foundations: Labs', term: 'Hepatitis Serologies', def: 'Hep B/C antigens/antibodies. Associated with Aplastic Anemia.' },
            { category: 'Foundations: Labs', term: 'EBV Serology', def: 'Detects EBV antibodies. Associated with Aplastic Anemia.' },


            // --- PHARMACOLOGY ---
            { category: 'Pharmacology', term: 'Warfarin', def: 'Vit K Antagonist. Teratogenic. Skin necrosis risk. Monitor INR.' },
            { category: 'Pharmacology', term: 'Heparin (Unfractionated Heparin - UFH)', def: 'Potentiates Antithrombin III. Monitor PTT. Reversal: Protamine.' },
            { category: 'Pharmacology', term: 'Low Molecular Weight Heparin (LMWH)', def: 'Anti-Xa activity. Renal clearance. Lower HIT risk. No routine monitoring.' },
            { category: 'Pharmacology', term: 'Aspirin (ASA)', def: 'Irreversible COX-1 inhibition. Blocks TXA2 production.' },
            { category: 'Pharmacology', term: 'Clopidogrel', def: 'ADP receptor (P2Y12) blocker. Antiplatelet.' },
            { category: 'Pharmacology', term: 'Tissue Plasminogen Activator (tPA)', def: 'Converts Plasminogen to Plasmin. Fibrinolytic "Clot Buster".' },
            { category: 'Pharmacology', term: 'Direct Oral Anticoagulants (DOACs)', def: 'Dabigatran (IIa inhibitor), Rivaroxaban/Apixaban (Xa inhibitors).' },

            // --- PARASITES ---
            { category: 'Module: Parasites', term: 'Babesiosis', def: 'Maltese Cross, Ixodes tick. Hemolytic anemia. NE USA.' },
            { category: 'Module: Parasites', term: 'Plasmodium Falciparum', def: 'Banana gametocytes. Severe malaria. Cerebral malaria.' },
            { category: 'Module: Parasites', term: 'Plasmodium Vivax/Ovale', def: 'Hypnozoites (Relapse). Treat with Primaquine.' },
            { category: 'Module: Parasites', term: 'Plasmodium Malariae', def: 'Band-form trophozoites. Quartan fever.' },
            { category: 'Module: Parasites', term: 'Wuchereria bancrofti', def: 'Lymphatic Filariasis. Elephantiasis. Night blood smear.' },

            // --- FOUNDATIONS: RBC MORPHOLOGY (NEWLY ADDED) ---
            { category: 'Foundations: RBC Morphology', term: 'Normal Morphology', def: 'Biconcave disc, Normocytic (normal size), Normochromic (normal color). Flexible.' },
            { category: 'Foundations: RBC Morphology', term: 'Microcytosis', def: 'Small cells (MCV < 80 fL), often Hypochromic. Seen in Iron Deficiency, Thalassemia, ACD.' },
            { category: 'Foundations: RBC Morphology', term: 'Macrocytosis', def: 'Large cells (MCV > 100 fL). Seen in B12/Folate deficiency (DNA maturation defect), Alcoholism, Liver disease.' },
            { category: 'Foundations: RBC Morphology', term: 'Polychromasia', def: 'Bluish-gray tint (residual RNA), often larger. Indicates Reticulocytosis (marrow response).' },
            { category: 'Foundations: RBC Morphology', term: 'Hypochromia', def: 'Increased central pallor (>1/3 diameter). "Onion ring" look. Iron Deficiency, Thalassemia.' },
            { category: 'Foundations: RBC Morphology', term: 'Spherocytes', def: 'Spherical, no central pallor. Hereditary Spherocytosis (membrane defect) or Autoimmune Hemolysis (macrophage bite).' },
            { category: 'Foundations: RBC Morphology', term: 'Target Cells (Codocytes)', def: 'Bullseye appearance (membrane excess). Thalassemia, Liver Disease, HbC, Asplenia.' },
            { category: 'Foundations: RBC Morphology', term: 'Schistocytes', def: 'Fragmented/Helmet cells. Mechanical damage (MAHA: TTP, HUS, DIC) or mechanical valves.' },
            { category: 'Foundations: RBC Morphology', term: 'Echinocytes (Burr Cells)', def: 'Regular, short spikes. Uremia (Renal Failure), Liver Disease, Artifact.' },
            { category: 'Foundations: RBC Morphology', term: 'Acanthocytes (Spur Cells)', def: 'Irregular, long spikes. Severe Liver Disease, Abetalipoproteinemia (Lipid imbalance).' },
            { category: 'Foundations: RBC Morphology', term: 'Teardrop Cells (Dacrocytes)', def: 'Teardrop shape. Bone Marrow Infiltration (Myelofibrosis), Thalassemia.' },
            { category: 'Foundations: RBC Morphology', term: 'Sickle Cells (Drepanocytes)', def: 'Crescent/Sickle shape. Sickle Cell Disease (HbS polymerization under low O2).' },
            { category: 'Foundations: RBC Morphology', term: 'Stomatocytes', def: 'Slit-like "fish mouth" central pallor. Hereditary Stomatocytosis, Alcoholism, Liver Disease.' },
            { category: 'Foundations: RBC Morphology', term: 'Bite Cells', def: 'Semicircular bite removed. G6PD Deficiency (Macrophage pits Heinz bodies).' },
            { category: 'Foundations: RBC Morphology', term: 'Howell-Jolly Bodies', def: 'Small, round, blue/purple nuclear remnant. Seen in Splenectomy or functional asplenia.' },
            { category: 'Foundations: RBC Morphology', term: 'Basophilic Stippling', def: 'Fine blue granules (ribosomes/RNA) throughout cell. Lead Poisoning, Thalassemia, Alcohol.' },
            { category: 'Foundations: RBC Morphology', term: 'Rouleaux Formation', def: 'RBCs stacked like coins. Multiple Myeloma, chronic inflammation (Excess proteins neutralize charge).' },
            { category: 'Foundations: RBC Morphology', term: 'Agglutination', def: 'Clumping of RBCs into irregular masses. Cold Agglutinin Disease (IgM antibodies).' },
            { category: 'Foundations: RBC Morphology', term: 'Heinz Bodies', def: 'Denatured hemoglobin (requires supravital stain). G6PD Deficiency.' },
            { category: 'Foundations: RBC Morphology', term: 'Pappenheimer Bodies', def: 'Iron granules (Perls stain). Sideroblastic anemia, Post-splenectomy.' }
        ];

        // --- IMAGE BANK DATA (PLACEHOLDERS) ---
        const IMAGE_BANK_DATA = [
            // Module 11 (Hemopoiesis)
            { id: 'img_ls11_01', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-01.jpg', title: 'Bone Marrow Section', desc: 'Histological section of hematopoietic bone marrow filled with nucleated precursors.' },
            { id: 'img_ls11_02', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-02.jpg', title: 'Yellow Bone Marrow', desc: 'Section showing adipose-rich yellow marrow with large unilocular fat cells.' },
            { id: 'img_ls11_03', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-03.jpg', title: 'Erythroblast Stages', desc: 'Smear with large basophilic cell (A) and smaller basophilic erythroblast (B).' },
            { id: 'img_ls11_04', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-04.jpg', title: 'Erythroblast Maturation', desc: 'Progression from basophilic to polychromatophilic erythroblast.' },
            { id: 'img_ls11_05', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-05.jpg', title: 'Neutrophil and RBCs', desc: 'Smear with neutrophil and surrounding erythrocytes.' },
            { id: 'img_ls11_06', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-06.jpg', title: 'Band Neutrophil', desc: 'Neutrophil precursor with curved, unsegmented nucleus (band form).' },
            { id: 'img_ls11_07', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-07.jpg', title: 'Myelocyte', desc: 'Granulocyte precursor with specific granules and eccentric nucleus.' },
            { id: 'img_ls11_08', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-08.jpg', title: 'Metamyelocyte', desc: 'Granulocyte precursor with indented nucleus.' },
            { id: 'img_ls11_09', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_11_Hemopoesis/LS11-09.jpg', title: 'Eosinophil', desc: 'Granulocyte with bi-lobed nucleus and red-orange granules.' },
            // Module 9 (Vessels)
            { id: 'img_ls9_01', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-01.jpg', title: 'RBC Rouleaux', desc: 'RBCs adhering like a stack of coins.' },
            { id: 'img_ls9_02', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-02.jpg', title: 'Platelets and Neutrophil', desc: 'Platelets as small basophilic particles next to a neutrophil.' },
            { id: 'img_ls9_03', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-03.jpg', title: 'Arteriole Cross Section', desc: 'Arteriole with smooth muscle layer and internal elastic lamina.' },
            { id: 'img_ls9_04', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-04.jpg', title: 'Venule', desc: 'Thin-walled venule accompanying an arteriole.' },
            { id: 'img_ls9_05', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-05.jpg', title: 'Capillary Bed', desc: 'Network of capillaries perfusing tissue.' },
            { id: 'img_ls9_06', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-06.jpg', title: 'Lymphatic Vessel', desc: 'Lymphatic vessel with thin wall and valve.' },
            { id: 'img_ls9_07', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-07.jpg', title: 'Large Vein Wall', desc: 'Tunica adventitia of a large vein with vasa vasorum.' },
            { id: 'img_ls9_08', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-08.jpg', title: 'Elastic Artery', desc: 'Aorta wall showing multiple elastic lamellae in media.' },
             { id: 'img_ls9_09', src: 'https://tayner35.github.io/HemeLymphE1-Images/Mod_9_Vessels/LS9-09.jpg', title: 'Muscular Artery', desc: 'Muscular artery with prominent internal elastic lamina.' },
        ];


        // --- FLOWCHART NODES & CONNECTIONS ---
        // GRID SYSTEM: Col Width 200px, Row Height 140px
        
        // --- CONNECTIONS FOR ARROWS ---
        const FLOWCHART_CONNECTIONS = [
            { from: 'h1', to: 'micro_step1' }, 
            { from: 'h2', to: 'normo_step1' }, 
            { from: 'h3', to: 'macro_step1' },
            
            // Micro
            { from: 'micro_step1', to: 'micro_low_iron' }, { from: 'micro_step1', to: 'micro_high_iron' },
            { from: 'micro_low_iron', to: 'lbl_low_ferritin' }, { from: 'micro_low_iron', to: 'lbl_high_ferritin' }, { from: 'micro_low_iron', to: 'lbl_norm_ferritin' },
            { from: 'micro_high_iron', to: 'lbl_sid_ferritin' },
            { from: 'lbl_low_ferritin', to: 'drop_ida' }, { from: 'lbl_high_ferritin', to: 'drop_acd' }, { from: 'lbl_norm_ferritin', to: 'drop_thal' },
            { from: 'lbl_sid_ferritin', to: 'drop_sidero' },

            // Normo
            { from: 'normo_step1', to: 'normo_low_retic' }, { from: 'normo_step1', to: 'normo_high_retic' },
            { from: 'normo_low_retic', to: 'lbl_pancyto' }, { from: 'normo_low_retic', to: 'lbl_no_pancyto' },
            { from: 'lbl_pancyto', to: 'drop_aplastic' }, { from: 'lbl_no_pancyto', to: 'drop_prca' },
            { from: 'normo_high_retic', to: 'lbl_inherited' }, { from: 'normo_high_retic', to: 'lbl_acquired' },
            { from: 'lbl_inherited', to: 'lbl_bite' }, { from: 'lbl_inherited', to: 'lbl_sickle' },
            { from: 'lbl_bite', to: 'drop_g6pd' }, { from: 'lbl_sickle', to: 'drop_sickle' },
            { from: 'lbl_acquired', to: 'lbl_coombs_pos' }, { from: 'lbl_acquired', to: 'lbl_coombs_neg' },
            { from: 'lbl_coombs_pos', to: 'drop_warm' }, { from: 'lbl_coombs_pos', to: 'drop_cold' }, 
            { from: 'lbl_coombs_neg', to: 'lbl_cd55' },
            { from: 'lbl_cd55', to: 'drop_pnh' }, { from: 'lbl_cd55', to: 'drop_ttp' },

            // Macro
            { from: 'macro_step1', to: 'macro_mega' },
            { from: 'macro_mega', to: 'macro_copper' },
            { from: 'macro_copper', to: 'lbl_low_copper' }, { from: 'macro_copper', to: 'lbl_norm_copper' },
            { from: 'lbl_low_copper', to: 'drop_copper' },
            { from: 'lbl_norm_copper', to: 'drop_b12' }, { from: 'lbl_norm_copper', to: 'drop_folate' }
        ];


        // --- STATE ---
        let gameState = 'menu'; 
        let selectedCategory = 'All';
        let deck = [];
        let leftCol = [];
        let rightCol = [];
        let selectedLeft = null;
        let selectedRight = null;
        let matchedIds = [];
        let wrongPair = null; 
        let score = 0;
        let mistakes = 0;
        let hiddenModules = new Set(); // Track hidden modules

        // Flowchart State
        let fcZoom = 0.45; // Adjusted start zoom to see more
        let fcPanX = 0; // Adjusted Pan X
        let fcPanY = 0; // Adjusted Pan Y
        let isDraggingChart = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let heldItem = null;
        let placedItems = {}; 


        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const gameStats = document.getElementById('game-stats');
        const flowchartControls = document.getElementById('flowchart-controls');
        const progressDisplay = document.getElementById('progress-display');
        const scoreDisplay = document.getElementById('score-display');
        const closeBtn = document.getElementById('close-btn');
        const headerControls = document.getElementById('header-controls');
        const imageModal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-img');
        const modalCaption = document.getElementById('modal-caption');
        const modalTitle = document.getElementById('modal-title'); // Added title element

        // --- INITIALIZATION ---
        function init() {
            renderMenu();
        }

        // --- MATCHING GAME LOGIC ---

        function startGame(catId) {
            // Check if user is trying to start a hidden module directly (e.g. from the list)
            // But UI disables hidden ones anyway. Just a safety check.
            if (hiddenModules.has(catId)) return;

            selectedCategory = catId;
            let filtered = catId === 'All' ? [...FULL_DATA] : FULL_DATA.filter(item => item.category === catId);
            
            // If Master Exam, remove hidden modules
            if (catId === 'All') {
                filtered = filtered.filter(item => !hiddenModules.has(item.category));
            }

            if (filtered.length === 0) {
                alert("No cards available in this selection!");
                return;
            }

            filtered.sort(() => 0.5 - Math.random());
            deck = filtered.map((item, idx) => ({ ...item, id: `item-${idx}` }));
            
            score = 0;
            mistakes = 0;
            matchedIds = [];
            leftCol = [...deck].sort(() => 0.5 - Math.random());
            rightCol = [...deck].sort(() => 0.5 - Math.random());
            
            gameState = 'playing';
            updateUI();
        }

        function handleLeftClick(id, term, def) {
            if (matchedIds.includes(id) || wrongPair) return;
            selectedLeft = (selectedLeft === id) ? null : id;
            checkMatch();
            renderBoard();
        }

        function handleRightClick(id, term, def) {
            if (matchedIds.includes(id) || wrongPair) return;
            selectedRight = (selectedRight === id) ? null : id;
            checkMatch();
            renderBoard();
        }

        function checkMatch() {
            if (!selectedLeft || !selectedRight) return;
            const leftId = selectedLeft;
            const rightId = selectedRight;

            if (leftId === rightId) {
                matchedIds.push(leftId);
                score += 100;
                selectedLeft = null;
                selectedRight = null;
                updateStats();
                if (matchedIds.length === deck.length) setTimeout(renderGameEnd, 800);
            } else {
                wrongPair = { left: leftId, right: rightId };
                mistakes++;
                updateStats();
                renderBoard();
                setTimeout(() => {
                    selectedLeft = null;
                    selectedRight = null;
                    wrongPair = null;
                    renderBoard();
                }, 1000);
            }
        }

        // --- FLOWCHART LOGIC ---

        function startFlowchart() {
            gameState = 'flowchart';
            fcZoom = 0.45; 
            fcPanX = 0;
            fcPanY = 0;
            placedItems = {};
            heldItem = null;
            score = 0;
            updateUI();
        }

        function pickupItem(answer) {
            if (heldItem === answer) {
                heldItem = null;
            } else {
                heldItem = answer;
            }
            renderFlowchart();
        }

        function placeItem(zoneId, correctAnswer) {
            if (!heldItem) return;

            if (heldItem === correctAnswer) {
                placedItems[zoneId] = heldItem;
                heldItem = null;
                score += 50;
                const totalDrops = FLOWCHART_NODES.filter(n => n.type === 'drop').length;
                if (Object.keys(placedItems).length === totalDrops) {
                    setTimeout(() => alert("Flowchart Complete! Great job."), 500);
                }
            } else {
                alert("Incorrect placement. Try again.");
            }
            renderFlowchart();
        }

        function adjustZoom(delta) {
            fcZoom = Math.max(0.4, Math.min(2.0, fcZoom + delta));
            renderFlowchart();
        }
        function resetZoom() {
            fcZoom = 0.45;
            fcPanX = 0;
            fcPanY = 0;
            renderFlowchart();
        }

        function handleChartMouseDown(e) {
            if (e.target.closest('.interactive-el')) return; 
            isDraggingChart = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            const container = document.getElementById('fc-container');
            container.style.cursor = 'grabbing';
        }
        
        function handleChartMouseMove(e) {
            if (!isDraggingChart) return;
            e.preventDefault();
            const dx = e.clientX - lastMouseX;
            const dy = e.clientY - lastMouseY;
            fcPanX += dx;
            fcPanY += dy;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            
            const content = document.getElementById('fc-content');
            content.style.transform = `translate(${fcPanX}px, ${fcPanY}px) scale(${fcZoom})`;
        }

        function handleChartMouseUp() {
            isDraggingChart = false;
            const container = document.getElementById('fc-container');
            if (container) container.style.cursor = 'grab';
        }

        // --- IMAGE BANK LOGIC ---
        function startImageBank() {
            gameState = 'imagebank';
            updateUI();
        }

        function openImageModal(src, title, desc) {
            modalImg.src = src;
            modalTitle.textContent = title;
            modalCaption.textContent = desc; // Use description if available
            imageModal.classList.remove('hidden');
        }

        function closeImageModal() {
            imageModal.classList.add('hidden');
            modalImg.src = ''; 
        }

        // --- TOGGLE LOGIC ---
        function toggleModule(moduleId) {
            if (hiddenModules.has(moduleId)) {
                hiddenModules.delete(moduleId);
            } else {
                hiddenModules.add(moduleId);
            }
            renderMenu(); // Re-render menu to reflect state
        }

        // --- RENDERERS ---

        function goToMenu() {
            gameState = 'menu';
            updateUI();
        }

        function updateUI() {
            // Set overflow based on mode to enable/disable scrolling
            if (gameState === 'flowchart') {
                mainContent.classList.remove('overflow-y-auto');
                mainContent.classList.add('overflow-hidden');
            } else {
                mainContent.classList.remove('overflow-hidden');
                mainContent.classList.add('overflow-y-auto');
            }

            // Controls Visibility
            if (gameState === 'menu') {
                gameStats.classList.add('hidden');
                closeBtn.classList.add('hidden');
                flowchartControls.classList.add('hidden');
            } else {
                closeBtn.classList.remove('hidden');
                
                if (gameState === 'playing') {
                    gameStats.classList.remove('hidden');
                    flowchartControls.classList.add('hidden');
                    updateStats();
                } else if (gameState === 'flowchart') {
                    gameStats.classList.add('hidden');
                    flowchartControls.classList.remove('hidden');
                } else if (gameState === 'imagebank') {
                    gameStats.classList.add('hidden');
                    flowchartControls.classList.add('hidden');
                }
            }

            // Main Content
            if (gameState === 'menu') renderMenu();
            else if (gameState === 'playing') renderBoard();
            else if (gameState === 'flowchart') renderFlowchart();
            else if (gameState === 'imagebank') renderImageBank();
            else if (gameState === 'game-end') renderGameEnd();
        }

        function updateStats() {
            progressDisplay.textContent = `${matchedIds.length} / ${deck.length}`;
            scoreDisplay.textContent = score;
        }

        function renderMenu() {
            mainContent.classList.remove('bg-slate-200'); // Clean slate
            mainContent.classList.add('px-4', 'py-6', 'max-w-6xl', 'mx-auto'); 
            
            // Build the HTML for active and hidden modules
            const activeGroupsHTML = renderCategoryGroups(false);
            const hiddenGroupsHTML = renderCategoryGroups(true);

            mainContent.innerHTML = `
                <div class="max-w-4xl mx-auto animate-slideIn">
                    <div class="text-center py-8">
                        <h2 class="text-3xl font-extrabold text-slate-800 mb-2">Select Your Module</h2>
                        <p class="text-slate-500">Structured learning from foundations to clinical application.</p>
                        <p class="text-xs text-slate-400 mt-2">Use the eye icon to hide/show modules from the "Master Exam"</p>
                    </div>

                    <!-- Interactive -->
                    <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                         <button onclick="startFlowchart()" class="flex flex-col p-4 bg-white rounded-xl border-2 border-indigo-100 hover:border-indigo-500 shadow-sm hover:shadow-md transition-all group text-left h-full">
                            <div class="p-3 rounded-lg bg-indigo-600 text-white w-fit mb-3 group-hover:scale-110 transition-transform shadow-sm">
                                ${ICONS.GitBranch}
                            </div>
                            <h3 class="font-bold text-slate-700 text-lg">Diagnostic Flowchart</h3>
                            <div class="text-sm font-semibold text-slate-400 mt-1">Interactive Algorithm</div>
                        </button>

                        <button onclick="startImageBank()" class="flex flex-col p-4 bg-white rounded-xl border-2 border-emerald-100 hover:border-emerald-500 shadow-sm hover:shadow-md transition-all group text-left h-full">
                            <div class="p-3 rounded-lg bg-emerald-600 text-white w-fit mb-3 group-hover:scale-110 transition-transform shadow-sm">
                                ${ICONS.Image}
                            </div>
                            <h3 class="font-bold text-slate-700 text-lg">Image Bank</h3>
                            <div class="text-sm font-semibold text-slate-400 mt-1">Pathology Gallery</div>
                        </button>
                    </div>
                    
                    <!-- Active Modules -->
                    <div id="active-modules-section">
                        ${activeGroupsHTML}
                    </div>

                    <!-- Hidden Modules Section (Only show if there are hidden modules) -->
                    ${hiddenModules.size > 0 ? `
                        <div id="hidden-modules-section" class="mt-12 border-t-2 border-slate-200 pt-8">
                            <h3 class="text-lg font-bold text-slate-400 uppercase tracking-wider mb-6 flex items-center gap-2">
                                ${ICONS.EyeOff} Hidden Modules
                            </h3>
                            <div class="opacity-75 grayscale hover:grayscale-0 transition-all duration-500">
                                ${hiddenGroupsHTML}
                            </div>
                        </div>
                    ` : ''}

                </div>
            `;
        }

        function renderCategoryGroups(renderHidden) {
             const GROUPS = [
                { title: "Red Cell Disorders", items: [
                    { id: 'Heme Synthesis', label: 'Heme Synthesis (Porphyrias)', icon: 'Activity', color: 'bg-purple-600' },
                    { id: 'Anemias: Hypoproliferative', label: 'Hypoproliferative Anemias', icon: 'Droplet', color: 'bg-red-500' },
                    { id: 'Hemolytic (Non-MAHA)', label: 'Hemolytic Anemias (Non-MAHA)', icon: 'Droplet', color: 'bg-red-600' },
                    { id: 'MAHAs', label: 'Microangiopathic Hemolytic Anemias', icon: 'ShieldAlert', color: 'bg-orange-600' },
                    { id: 'Bone Marrow Failure', label: 'Bone Marrow Failure', icon: 'Activity', color: 'bg-slate-600' },
                ]},
                { title: "Hemostasis & Thrombosis", items: [
                    { id: 'Coagulation & Platelets', label: 'Coagulation & Platelet Disorders', icon: 'ShieldAlert', color: 'bg-blue-600' },
                    { id: 'Foundations: Labs', label: 'Lab Diagnostics', icon: 'FlaskConical', color: 'bg-cyan-600' },
                ]},
                { title: "Others", items: [
                    { id: 'Pharmacology', label: 'Pharmacology', icon: 'Pill', color: 'bg-emerald-600' },
                    { id: 'Module: Parasites', label: 'Parasites & Malaria', icon: 'Bug', color: 'bg-lime-600' },
                    { id: 'Foundations: RBC Morphology', label: 'RBC Morphology', icon: 'Droplet', color: 'bg-rose-500' }
                ]},
                { title: "Comprehensive", items: [
                    { id: 'All', label: 'Master Exam (All Visible Content)', icon: 'TrophyBig', color: 'bg-slate-800' }
                ]}
            ];

            let html = '';

            GROUPS.forEach(group => {
                // Filter items based on whether we are rendering hidden or visible ones
                const items = group.items.filter(cat => {
                    const isHidden = hiddenModules.has(cat.id);
                    return renderHidden ? isHidden : !isHidden;
                });

                if (items.length > 0) {
                    html += `
                        <div class="mb-6">
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 px-2">${group.title}</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${items.map(cat => {
                                     const isMaster = cat.id === 'All';
                                     const isHidden = hiddenModules.has(cat.id);
                                     
                                     // Calculate count based on visibility
                                     let count = 0;
                                     if (isMaster) {
                                         // Sum of all NON-HIDDEN categories
                                         count = FULL_DATA.filter(i => !hiddenModules.has(i.category)).length;
                                     } else {
                                         count = FULL_DATA.filter(i => i.category === cat.id).length;
                                     }
        
                                     const icon = ICONS[cat.icon] || ICONS.Activity;
                                     
                                     // Determine click handler. If hidden, it does nothing (or alerts).
                                     // If visible, it starts game.
                                     const clickHandler = isHidden ? '' : `onclick="startGame('${cat.id}')"`;
                                     const cursorClass = isHidden ? 'cursor-not-allowed' : 'cursor-pointer hover:shadow-md hover:border-blue-300';
                                     const opacityClass = isHidden ? 'opacity-60 bg-slate-50' : 'bg-white';
                                     
                                     return `
                                        <div class="relative group">
                                            <button ${clickHandler} class="w-full flex items-center p-4 rounded-xl border border-slate-200 shadow-sm transition-all text-left ${cursorClass} ${opacityClass}">
                                                <div class="p-3 rounded-lg ${cat.color} text-white mr-4 group-hover:scale-110 transition-transform shadow-sm shrink-0">
                                                    ${icon}
                                                </div>
                                                <div>
                                                    <h3 class="font-bold text-slate-700 leading-tight">${cat.label}</h3>
                                                    <div class="text-xs font-semibold text-slate-400 mt-1 uppercase tracking-wide">
                                                        ${count} Cards
                                                    </div>
                                                </div>
                                            </button>
                                            
                                            ${!isMaster ? `
                                                <button onclick="event.stopPropagation(); toggleModule('${cat.id}')" 
                                                        class="absolute top-2 right-2 p-1.5 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-400 hover:text-slate-600 transition-colors z-10"
                                                        title="${isHidden ? 'Show Module' : 'Hide Module'}">
                                                    ${isHidden ? ICONS.EyeOff : ICONS.Eye}
                                                </button>
                                            ` : ''}
                                        </div>
                                     `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            return html;
        }

        // --- RENDER FLOWCHART ---
        function renderFlowchart() {
            mainContent.classList.remove('px-4', 'max-w-6xl');
            mainContent.classList.add('bg-slate-200'); 
            mainContent.innerHTML = '';

            const bankItems = FLOWCHART_NODES
                .filter(n => n.type === 'drop')
                .map(n => n.answer)
                .filter((v, i, a) => a.indexOf(v) === i)
                .sort();

            const sidebarHTML = `
                <div class="absolute left-4 top-4 bottom-4 w-64 bg-white/90 backdrop-blur rounded-2xl shadow-xl z-20 flex flex-col overflow-hidden border border-slate-200">
                    <div class="p-4 bg-slate-50 border-b border-slate-200">
                        <h3 class="font-bold text-slate-800">Term Bank</h3>
                        <p class="text-xs text-slate-500">Tap to pickup, Tap blank to place</p>
                    </div>
                    <div class="p-2 overflow-y-auto flex-grow space-y-2">
                        ${bankItems.map(term => {
                            const totalNeeded = FLOWCHART_NODES.filter(n => n.answer === term).length;
                            const currentPlaced = Object.values(placedItems).filter(v => v === term).length;
                            const isDone = currentPlaced >= totalNeeded;
                            const isHeld = heldItem === term;

                            return `
                                <button 
                                    onclick="pickupItem('${term}')"
                                    class="w-full text-left p-3 text-sm font-semibold rounded-lg transition-all
                                    ${isDone ? 'bg-slate-100 text-slate-400 line-through' : 
                                      isHeld ? 'bg-blue-600 text-white shadow-lg scale-105 ring-2 ring-blue-300' : 
                                      'bg-white border border-slate-200 hover:bg-blue-50 hover:border-blue-300 text-slate-700 shadow-sm'}
                                    "
                                    ${isDone ? 'disabled' : ''}
                                >
                                    ${term}
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            let chartHTML = '';
            
            // Draw Connectors first (behind nodes)
            let connectorsHTML = '';
            FLOWCHART_CONNECTIONS.forEach(conn => {
                const source = FLOWCHART_NODES.find(n => n.id === conn.from);
                const dest = FLOWCHART_NODES.find(n => n.id === conn.to);
                
                if (source && dest) {
                    // Coordinates scaled by 200 (X) and 120 (Y) approx
                    const sx = source.x * 220 + ((source.w * 220) - 20) / 2;
                    const sy = source.y * 140 + 80; // Bottom of source
                    const dx = dest.x * 220 + ((dest.w * 220) - 20) / 2;
                    const dy = dest.y * 140;      // Top of dest
                    
                    connectorsHTML += `
                        <line x1="${sx}" y1="${sy}" x2="${dx}" y2="${dy}" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)" />
                    `;
                }
            });

            // Draw Nodes
            FLOWCHART_NODES.forEach(node => {
                const left = node.x * 220;
                const top = node.y * 140;
                const width = (node.w * 220) - 20; 
                
                let content = '';
                if (node.type === 'label') {
                    content = `
                        <div class="absolute flex items-center justify-center p-2 text-center rounded-xl shadow-sm border-2 font-bold text-slate-700 leading-tight
                                    ${node.color || 'bg-white border-slate-200'}"
                             style="left: ${left}px; top: ${top}px; width: ${width}px; height: 80px;">
                            ${node.text}
                        </div>
                    `;
                } else if (node.type === 'drop') {
                    const isFilled = placedItems[node.id];
                    const isActive = heldItem && !isFilled;
                    content = `
                        <div onclick="placeItem('${node.id}', '${node.answer}')"
                             class="interactive-el absolute flex items-center justify-center p-2 text-center rounded-xl border-2 font-bold text-sm transition-all drop-zone
                                    ${isFilled 
                                        ? (node.isFinal ? 'bg-green-100 border-green-500 text-green-800' : 'bg-blue-100 border-blue-500 text-blue-800')
                                        : 'bg-white border-dashed border-slate-300 text-slate-400 hover:border-blue-400 cursor-pointer'}
                                    ${isActive ? 'animate-pulse bg-blue-50' : ''}"
                             style="left: ${left}px; top: ${top}px; width: ${width}px; height: 80px;">
                            ${isFilled ? isFilled : (isActive ? 'Place Here' : '?')}
                        </div>
                    `;
                }
                chartHTML += content;
            });

            const svgLines = `
                <svg class="absolute top-0 left-0 w-full h-full pointer-events-none" style="z-index: 0;">
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#94a3b8" />
                        </marker>
                    </defs>
                    ${connectorsHTML}
                </svg>
            `;

            mainContent.innerHTML = `
                ${sidebarHTML}
                <div id="fc-container" class="w-full h-full overflow-hidden relative flowchart-container"
                     onmousedown="handleChartMouseDown(event)"
                     onmousemove="handleChartMouseMove(event)"
                     onmouseup="handleChartMouseUp()"
                     onmouseleave="handleChartMouseUp()">
                     
                    <div id="fc-content" style="transform: translate(${fcPanX}px, ${fcPanY}px) scale(${fcZoom}); width: 4200px; height: 2000px; position: relative;">
                        ${svgLines}
                        ${chartHTML}
                    </div>
                </div>
            `;
        }

        function renderBoard() {
             mainContent.classList.remove('bg-slate-200'); 
             mainContent.classList.add('px-4', 'max-w-6xl', 'mx-auto'); 
             
            let html = `
                <div class="animate-fadeIn pb-12">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-12 relative">
                        
                        <!-- LEFT COL -->
                        <div class="flex flex-col gap-3">
                            <h3 class="text-slate-400 font-bold uppercase text-xs tracking-wider mb-2 text-center md:text-left sticky top-0 bg-slate-50 py-2 z-10">Terms / Disease</h3>
            `;

            leftCol.forEach(item => {
                const isMatched = matchedIds.includes(item.id);
                const isSelected = selectedLeft === item.id;
                const isError = wrongPair?.left === item.id;
                
                let btnClass = "card-btn w-full text-left p-4 rounded-xl border-2 transition-all relative flex items-center justify-between min-h-[4rem] ";
                let textClass = "font-bold text-sm md:text-base ";

                if (isMatched) {
                    btnClass += "bg-slate-50 border-slate-100 text-slate-300 opacity-50 cursor-default";
                    textClass += "line-through";
                } else if (isError) {
                    btnClass += "bg-red-50 border-red-500 animate-shake z-10";
                    textClass += "text-slate-800";
                } else if (isSelected) {
                    btnClass += "bg-blue-50 border-blue-500 shadow-md z-10";
                    textClass += "text-slate-800";
                } else {
                    btnClass += "bg-white border-slate-200 hover:border-blue-300 hover:shadow-sm";
                    textClass += "text-slate-800";
                }

                html += `
                    <button onclick="handleLeftClick('${item.id}', '${item.term}', '${item.def}')" ${isMatched ? 'disabled' : ''} class="${btnClass}">
                        <span class="${textClass}">${item.term}</span>
                    </button>
                `;
            });

            html += `</div>`; // End Left Col

            html += `<div class="hidden md:block absolute left-1/2 top-10 bottom-4 w-px bg-slate-200 -translate-x-1/2"></div>`;

            // RIGHT COL
            html += `<div class="flex flex-col gap-3">
                        <h3 class="text-slate-400 font-bold uppercase text-xs tracking-wider mb-2 text-center md:text-left sticky top-0 bg-slate-50 py-2 z-10">Mechanism / Findings</h3>`;

            rightCol.forEach(item => {
                const isMatched = matchedIds.includes(item.id);
                const isSelected = selectedRight === item.id;
                const isError = wrongPair?.right === item.id;

                let btnClass = "card-btn w-full text-left p-4 rounded-xl border-2 transition-all min-h-[4rem] flex items-center ";
                let textClass = "text-sm leading-snug ";

                if (isMatched) {
                    btnClass += "bg-slate-50 border-slate-100 text-slate-300 opacity-50 cursor-default";
                    textClass += "line-through";
                } else if (isError) {
                    btnClass += "bg-red-50 border-red-500 animate-shake z-10";
                    textClass += "text-slate-600 font-medium";
                } else if (isSelected) {
                    btnClass += "bg-blue-50 border-blue-500 shadow-md z-10";
                    textClass += "text-slate-600 font-medium";
                } else {
                    btnClass += "bg-white border-slate-200 hover:border-blue-300 hover:shadow-sm";
                    textClass += "text-slate-600 font-medium";
                }

                html += `
                    <button onclick="handleRightClick('${item.id}', '${item.term}', '${item.def}')" ${isMatched ? 'disabled' : ''} class="${btnClass}">
                        <span class="${textClass}">${item.def}</span>
                    </button>
                `;
            });

            html += `</div></div></div>`;
            mainContent.innerHTML = html;
        }

        function renderGameEnd() {
            mainContent.classList.remove('bg-slate-200'); 
            mainContent.classList.add('px-4', 'max-w-6xl', 'mx-auto'); 
            
            mainContent.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[60vh] animate-popIn">
                    <div class="bg-yellow-100 text-yellow-600 p-6 rounded-full mb-6">
                        ${ICONS.TrophyBig}
                    </div>
                    <h2 class="text-4xl font-extrabold text-slate-800 mb-4">Module Complete!</h2>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 w-full max-w-sm mb-8">
                        <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-4">
                            <span class="text-slate-500 font-medium">Final Score</span>
                            <span class="text-2xl font-bold text-blue-600">${score}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500 font-medium">Mistakes</span>
                            <span class="text-2xl font-bold ${mistakes === 0 ? 'text-green-500' : 'text-red-500'}">
                                ${mistakes}
                            </span>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="goToMenu()" class="px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-xl font-bold transition-colors">
                            Back to Menu
                        </button>
                        <button onclick="startGame('${selectedCategory}')" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-colors flex items-center gap-2">
                            ${ICONS.RotateCcw} Replay
                        </button>
                    </div>
                </div>
            `;
        }

        // Initialize the app
        init();

    </script>
</body>
</html>
