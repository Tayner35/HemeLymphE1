<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heme-Lymph Match + AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <style>
        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .animate-shake {
            animation: shake 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fadeIn {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-popIn {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        
        /* Pulse for selections */
        .selected-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        /* Flowchart Specific Styles */
        .flowchart-container {
            cursor: grab;
            transform-origin: top left;
            transition: transform 0.1s ease-out;
        }
        .flowchart-container:active {
            cursor: grabbing;
        }
        
        /* AI Mode Styles */
        .tutor-mode-active .card-btn {
            border-color: #8b5cf6 !important; /* violet-500 */
            background-color: #f5f3ff !important; /* violet-50 */
            cursor: help !important;
        }
        .tutor-mode-active .card-btn:hover {
            background-color: #ede9fe !important; /* violet-100 */
            transform: scale(1.02);
        }
        
        /* Custom Scrollbar for nicer look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- HEADER (Fixed at top) -->
    <header class="bg-white border-b border-slate-200 shadow-sm z-30 flex-none h-16">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <!-- BookOpen Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                </div>
                <h1 class="font-bold text-xl hidden sm:block">Heme-Lymph Match</h1>
                <h1 class="font-bold text-xl sm:hidden">HL Match</h1>
            </div>

            <!-- Header Controls -->
            <div id="header-controls" class="flex items-center gap-2 sm:gap-4 text-sm font-semibold">
                
                <!-- AI Tutor Toggle (Visible in Playing Mode) -->
                <button id="ai-tutor-toggle" onclick="toggleAITutor()" class="hidden flex items-center gap-2 px-3 py-1.5 rounded-full border border-slate-200 text-slate-600 hover:bg-violet-50 hover:text-violet-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
                    <span id="tutor-text">AI Tutor: Off</span>
                </button>

                <!-- Flowchart Controls -->
                <div id="flowchart-controls" class="hidden flex items-center gap-1">
                    <button onclick="adjustZoom(-0.1)" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
                    <button onclick="resetZoom()" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg></button>
                    <button onclick="adjustZoom(0.1)" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
                </div>

                <!-- Score Stats -->
                <div id="game-stats" class="hidden flex items-center gap-4">
                    <div class="flex items-center gap-2 text-slate-500">
                        <span id="progress-display" class="bg-slate-100 px-2 py-1 rounded text-slate-700">0 / 0</span>
                    </div>
                    <div class="flex items-center gap-2 text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                        <span id="score-display">0</span>
                    </div>
                </div>

                <!-- Close Button -->
                <button id="close-btn" onclick="goToMenu()" class="hidden text-slate-400 hover:text-slate-600 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT AREA (Scrollable) -->
    <main id="main-content" class="w-full flex-grow relative overflow-y-auto bg-slate-100">
        <!-- Content injected by JS -->
    </main>

    <!-- AI MODAL -->
    <div id="ai-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-violet-50">
                <div class="flex items-center gap-2 text-violet-700">
                    <svg class="animate-pulse" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
                    <h3 id="ai-modal-title" class="font-bold text-lg">Gemini Analysis</h3>
                </div>
                <button onclick="closeAIModal()" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            
            <div id="ai-modal-content" class="p-6 overflow-y-auto prose prose-sm prose-slate">
                <!-- Content goes here -->
            </div>

            <!-- Loading State -->
            <div id="ai-loading" class="hidden p-12 flex flex-col items-center justify-center text-slate-500">
                <svg class="animate-spin-slow mb-4 text-violet-500" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                <p class="animate-pulse font-medium">Consulting Gemini...</p>
            </div>
            
             <div id="ai-modal-footer" class="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-2">
                 <button id="tts-btn" class="hidden flex items-center gap-2 px-4 py-2 bg-violet-100 text-violet-700 rounded-lg hover:bg-violet-200 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                     Read Aloud
                 </button>
                <button onclick="closeAIModal()" class="px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 text-slate-700">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- API CONFIG ---
        const apiKey = ""; // System injected
        
        // --- ICONS ---
        const ICONS = {
            Layers: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>`,
            Droplet: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></svg>`,
            Activity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
            ShieldAlert: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>`,
            Bug: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>`,
            FlaskConical: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>`,
            Pill: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg>`,
            CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>`,
            ArrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>`,
            TrophyBig: `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            RotateCcw: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>`,
            GitBranch: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>`,
            Sparkles: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>`,
            Stethoscope: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></svg>`,
            Microscope: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/><path d="M12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3"/></svg>`
        };

        // --- MATCHING GAME DATA ---
        const FULL_DATA = [
            { category: 'Foundations: Labs', term: 'PT (Prothrombin Time)', def: 'Measures Extrinsic Pathway (Factor VII). Uses Tissue Factor.' },
            { category: 'Foundations: Labs', term: 'aPTT', def: 'Measures Intrinsic Pathway (XII, XI, IX, VIII). Uses Silica/Kaolin.' },
            { category: 'Foundations: Labs', term: 'Bleeding Time', def: 'Measures Platelet Function/Adhesion (Primary Hemostasis).' },
            { category: 'Foundations: Labs', term: 'Thrombin Time', def: 'Measures Fibrinogen to Fibrin conversion.' },
            { category: 'Foundations: Labs', term: 'Mixing Study (Corrects)', def: 'Indicates a Factor Deficiency.' },
            { category: 'Foundations: Labs', term: 'Mixing Study (No Correction)', def: 'Indicates presence of an Inhibitor (e.g., Lupus Anticoagulant).' },
            { category: 'Foundations: Labs', term: 'D-Dimer', def: 'Measures cross-linked fibrin degradation. High in DIC, PE, DVT.' },
            { category: 'Foundations: Labs', term: 'Ristocetin Cofactor', def: 'Measures vWF activity/function. Abnormal in vWD.' },
            { category: 'Foundations: Labs', term: 'Direct Coombs', def: 'Detects antibodies bound to RBC surface (Autoimmune).' },
            { category: 'Foundations: Labs', term: 'Osmotic Fragility', def: 'Positive in Hereditary Spherocytosis.' },
            
            { category: 'Foundations: RBC Morphology', term: 'Microcytosis', def: 'MCV < 80. Iron Deficiency, Thalassemia.' },
            { category: 'Foundations: RBC Morphology', term: 'Macrocytosis', def: 'MCV > 100. B12/Folate Deficiency, Liver Disease.' },
            { category: 'Foundations: RBC Morphology', term: 'Target Cells', def: 'Thalassemia, Liver Disease, HbC.' },
            { category: 'Foundations: RBC Morphology', term: 'Spherocytes', def: 'No central pallor. Hereditary Spherocytosis, AIHA.' },
            { category: 'Foundations: RBC Morphology', term: 'Schistocytes', def: 'Fragmented RBCs. MAHA, TTP, HUS, DIC.' },
            { category: 'Foundations: RBC Morphology', term: 'Echinocytes', def: 'Burr cells. Uremia/Renal Failure.' },
            { category: 'Foundations: RBC Morphology', term: 'Howell-Jolly Bodies', def: 'Nuclear DNA remnants. Seen in Asplenia.' },
            { category: 'Foundations: RBC Morphology', term: 'Basophilic Stippling', def: 'Ribosome aggregation. Lead Poisoning, Thalassemia.' },
            { category: 'Foundations: RBC Morphology', term: 'Heinz Bodies', def: 'Denatured Hemoglobin. G6PD Deficiency.' },

            { category: 'Module: Disease Mechanisms', term: 'TTP', def: 'ADAMTS13 deficiency.' },
            { category: 'Module: Disease Mechanisms', term: 'HUS', def: 'Shiga-toxin E. coli O157:H7.' },
            { category: 'Module: Disease Mechanisms', term: 'PNH', def: 'PIG-A mutation -> CD55/59 deficiency.' },
            { category: 'Module: Disease Mechanisms', term: 'Sickle Cell', def: 'Glu -> Val mutation in Beta chain.' },
            { category: 'Module: Disease Mechanisms', term: 'G6PD Deficiency', def: 'Reduced NADPH -> Oxidative stress.' },
            { category: 'Module: Disease Mechanisms', term: 'Bernard-Soulier', def: 'GpIb deficiency (Adhesion).' },
            { category: 'Module: Disease Mechanisms', term: 'Glanzmann', def: 'GpIIb/IIIa deficiency (Aggregation).' },
            { category: 'Module: Disease Mechanisms', term: 'ITP', def: 'Antibodies against GpIIb/IIIa.' },
            { category: 'Module: Disease Mechanisms', term: 'Factor V Leiden', def: 'Factor V resistant to Protein C.' },

            { category: 'Module: Disease Labs', term: 'Iron Deficiency', def: 'Microcytic, Low Ferritin, High TIBC.' },
            { category: 'Module: Disease Labs', term: 'Anemia of Chronic Disease', def: 'High Ferritin, Low TIBC, High Hepcidin.' },
            { category: 'Module: Disease Labs', term: 'Sideroblastic Anemia', def: 'High Iron, Ringed Sideroblasts.' },
            { category: 'Module: Disease Labs', term: 'B12 Deficiency', def: 'Macrocytic, High MMA, High Homocysteine.' },
            { category: 'Module: Disease Labs', term: 'Hemolysis', def: 'High LDH, Low Haptoglobin, High Retics.' },
            { category: 'Module: Disease Labs', term: 'vWD', def: 'High Bleeding Time, Abnormal Ristocetin.' },
            { category: 'Module: Disease Labs', term: 'Hemophilia A', def: 'High PTT, Normal PT, Factor VIII low.' },
            { category: 'Module: Disease Labs', term: 'DIC', def: 'High PT, High PTT, Low Fibrinogen, High D-Dimer.' },

            { category: 'Module: Pharmacology', term: 'Warfarin', def: 'Vit K Antagonist. Monitor PT/INR.' },
            { category: 'Module: Pharmacology', term: 'Heparin (Unfractionated)', def: 'Activates Antithrombin III. Monitor PTT.' },
            { category: 'Module: Pharmacology', term: 'LMWH', def: 'Inhibits Factor Xa. Renal clearance.' },
            { category: 'Module: Pharmacology', term: 'Aspirin', def: 'Irreversible COX-1 inhibition.' },
            { category: 'Module: Pharmacology', term: 'Clopidogrel', def: 'Irreversible P2Y12 ADP blocker.' },
            { category: 'Module: Pharmacology', term: 'tPA', def: 'Fibrinolytic. Converts Plasminogen to Plasmin.' },

            { category: 'Module: Parasites', term: 'Babesiosis', def: 'Maltese Cross, Ixodes tick.' },
            { category: 'Module: Parasites', term: 'P. Falciparum', def: 'Banana gametocytes, Severe malaria.' },
            { category: 'Module: Parasites', term: 'P. Vivax', def: 'Hypnozoites (Relapse), Schuffner dots.' },
            { category: 'Module: Parasites', term: 'P. Malariae', def: 'Band-form trophozoites, Quartan fever.' },
            { category: 'Module: Parasites', term: 'Wuchereria bancrofti', def: 'Lymphatic Filariasis, Elephantiasis.' }
        ];

        // --- FLOWCHART DATA ---
        const FLOWCHART_NODES = [
            { id: 'h1', type: 'label', text: 'Microcytic (MCV < 80)', x: 1.5, y: 0.5, w: 3, color: 'bg-red-100 border-red-300' },
            { id: 'h2', type: 'label', text: 'Normocytic (MCV 80-100)', x: 7.5, y: 0.5, w: 5, color: 'bg-green-100 border-green-300' },
            { id: 'h3', type: 'label', text: 'Macrocytic (MCV > 96)', x: 14.5, y: 0.5, w: 3, color: 'bg-blue-100 border-blue-300' },

            // --- MICROCYTIC PATH ---
            { id: 'micro_step1', type: 'label', text: 'Step 1: Serum Iron Studies', x: 1.5, y: 2, w: 3, color: 'bg-white border-slate-300 font-bold' },
            { id: 'micro_low_iron', type: 'label', text: '↓ Iron', x: 0.5, y: 3.5, w: 2, color: 'bg-slate-50 text-red-600' },
            { id: 'lbl_low_ferritin', type: 'label', text: '↓ Ferritin', x: 0, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_high_ferritin', type: 'label', text: '↑ Ferritin', x: 1, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_norm_ferritin', type: 'label', text: 'Normal Ferritin', x: 2, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_ida', type: 'drop', answer: 'Iron Deficiency Anaemia', x: 0, y: 6.5, w: 1, isFinal: true },
            { id: 'drop_acd', type: 'drop', answer: 'Anaemia of Chronic Disease', x: 1, y: 6.5, w: 1, isFinal: true },
            { id: 'drop_thal', type: 'drop', answer: 'Thalassemia', x: 2, y: 6.5, w: 1, isFinal: true },
            { id: 'micro_high_iron', type: 'label', text: '↑ Iron', x: 3.5, y: 3.5, w: 1, color: 'bg-slate-50 text-red-600' },
            { id: 'lbl_sid_ferritin', type: 'label', text: '↓ Ferritin (Chart Logic)', x: 3.5, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_sidero', type: 'drop', answer: 'Sideroblastic Anaemia', x: 3.5, y: 6.5, w: 1, isFinal: true },

            // --- NORMOCYTIC PATH ---
            { id: 'normo_step1', type: 'label', text: 'Step 1: Reticulocyte Count', x: 7.5, y: 2, w: 5, color: 'bg-white border-slate-300 font-bold' },
            { id: 'normo_low_retic', type: 'label', text: '< 2% (Low Production)', x: 5.5, y: 3.5, w: 2, color: 'bg-slate-50 text-green-700' },
            { id: 'lbl_pancyto', type: 'label', text: 'Pancytopenia Present', x: 5, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_no_pancyto', type: 'label', text: 'Pancytopenia Absent', x: 6, y: 5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_aplastic', type: 'drop', answer: 'Aplastic Anaemia', x: 5, y: 6.5, w: 1, isFinal: true },
            { id: 'drop_prca', type: 'drop', answer: 'Pure Red Cell Aplasia', x: 6, y: 6.5, w: 1, isFinal: true },
            { id: 'normo_high_retic', type: 'label', text: '> 2% (Hemolytic)', x: 9, y: 3.5, w: 3.5, color: 'bg-slate-50 text-green-700' },
            { id: 'lbl_inherited', type: 'label', text: 'Inherited Causes', x: 8, y: 5, w: 1.5, color: 'bg-green-50 border-green-200' },
            { id: 'lbl_bite', type: 'label', text: 'Bite/Heinz Cells', x: 7.5, y: 6.5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_sickle', type: 'label', text: 'Sickle Cells', x: 8.5, y: 6.5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_g6pd', type: 'drop', answer: 'G6PD Deficiency', x: 7.5, y: 8, w: 1, isFinal: true },
            { id: 'drop_sickle', type: 'drop', answer: 'Sickle Cell Anaemia', x: 8.5, y: 8, w: 1, isFinal: true },
            { id: 'lbl_acquired', type: 'label', text: 'Acquired (Direct Coombs)', x: 10.5, y: 5, w: 2, color: 'bg-green-50 border-green-200' },
            { id: 'lbl_coombs_pos', type: 'label', text: 'Positive (+)', x: 9.75, y: 6.5, w: 1.5, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_warm', type: 'drop', answer: 'Warm AIHA (IgG)', x: 9.5, y: 8, w: 1, isFinal: true },
            { id: 'drop_cold', type: 'drop', answer: 'Cold AIHA (IgM)', x: 10.5, y: 8, w: 1, isFinal: true },
            { id: 'lbl_coombs_neg', type: 'label', text: 'Negative (-)', x: 11.75, y: 6.5, w: 1.5, color: 'bg-white border-dashed text-xs' },
            { id: 'lbl_cd55', type: 'label', text: 'Test CD55/59', x: 11.75, y: 8, w: 1.5, color: 'bg-white border-slate-200' },
            { id: 'drop_pnh', type: 'drop', answer: 'PNH (Neg CD55)', x: 11.25, y: 9.5, w: 1, isFinal: true },
            { id: 'drop_ttp', type: 'drop', answer: 'TTP (Pos? Check ADAMTS13)', x: 12.25, y: 9.5, w: 1.2, isFinal: true },

            // --- MACROCYTIC PATH ---
            { id: 'macro_step1', type: 'label', text: 'Step 1: Check Smear', x: 14.5, y: 2, w: 3, color: 'bg-white border-slate-300 font-bold' },
            { id: 'macro_mega', type: 'label', text: 'Megaloblastic Features Present?', x: 14.5, y: 3.5, w: 3, color: 'bg-slate-50 text-blue-700' },
            { id: 'macro_copper', type: 'label', text: 'Step 2: Check Copper', x: 14.5, y: 5, w: 3, color: 'bg-white border-slate-300' },
            { id: 'lbl_low_copper', type: 'label', text: '↓ Copper', x: 13.5, y: 6.5, w: 1, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_copper', type: 'drop', answer: 'Copper Deficiency', x: 13.5, y: 8, w: 1, isFinal: true },
            { id: 'lbl_norm_copper', type: 'label', text: 'Normal Copper (Check MMA)', x: 15.5, y: 6.5, w: 2, color: 'bg-white border-dashed text-xs' },
            { id: 'drop_b12', type: 'drop', answer: 'B12 Deficiency (↑ MMA)', x: 15, y: 8, w: 1.5, isFinal: true },
            { id: 'drop_folate', type: 'drop', answer: 'Folate Deficiency (Norm MMA)', x: 16.5, y: 8, w: 1.5, isFinal: true },
        ];

        // --- STATE ---
        let gameState = 'menu'; 
        let selectedCategory = 'All';
        let deck = [];
        let leftCol = [];
        let rightCol = [];
        let selectedLeft = null;
        let selectedRight = null;
        let matchedIds = [];
        let wrongPair = null; 
        let score = 0;
        let mistakes = 0;
        let aiTutorMode = false;

        // Flowchart State
        let fcZoom = 0.6; // Start zoomed out further
        let fcPanX = 50;
        let fcPanY = 50;
        let isDraggingChart = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let heldItem = null;
        let placedItems = {}; 

        // AI Case State
        let currentCase = null;
        let caseAnswered = false;

        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const gameStats = document.getElementById('game-stats');
        const matchStats = document.getElementById('match-stats');
        const flowchartControls = document.getElementById('flowchart-controls');
        const progressDisplay = document.getElementById('progress-display');
        const scoreDisplay = document.getElementById('score-display');
        const aiTutorToggle = document.getElementById('ai-tutor-toggle');
        const tutorText = document.getElementById('tutor-text');
        const closeBtn = document.getElementById('close-btn');
        const headerControls = document.getElementById('header-controls');
        const aiModal = document.getElementById('ai-modal');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiModalContent = document.getElementById('ai-modal-content');
        const aiLoading = document.getElementById('ai-loading');
        const ttsBtn = document.getElementById('tts-btn');

        // --- INITIALIZATION ---
        function init() {
            renderMenu();
        }

        // --- GEMINI API CALLS ---

        async function callGemini(prompt, systemInstruction = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        async function generateTTS(text) {
             const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
             
             const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                }
             };

             try {
                 const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                 });
                 if (!response.ok) throw new Error("TTS Error");
                 const data = await response.json();
                 return data.candidates[0].content.parts[0].inlineData.data; // Base64 PCM
             } catch (e) {
                 console.error(e);
                 return null;
             }
        }

        function playPCM(base64Data) {
            const binaryString = atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            // Add WAV header to PCM data
            const wavBytes = addWavHeader(bytes, 24000, 1);
            const blob = new Blob([wavBytes], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            audio.play();
        }
        
        function addWavHeader(samples, sampleRate, numChannels) {
            const buffer = new ArrayBuffer(44 + samples.length);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + samples.length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * 2, true);
            view.setUint16(32, numChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, samples.length, true);

            // Copy PCM data
            const dataView = new Uint8Array(buffer, 44);
            dataView.set(samples);

            return buffer;
        }


        // --- AI FEATURES LOGIC ---

        function toggleAITutor() {
            aiTutorMode = !aiTutorMode;
            const btn = document.getElementById('ai-tutor-toggle');
            if (aiTutorMode) {
                btn.classList.add('bg-violet-100', 'text-violet-700', 'border-violet-300');
                btn.classList.remove('text-slate-600', 'border-slate-200');
                tutorText.textContent = "AI Tutor: ON";
                document.body.classList.add('tutor-mode-active');
            } else {
                btn.classList.remove('bg-violet-100', 'text-violet-700', 'border-violet-300');
                btn.classList.add('text-slate-600', 'border-slate-200');
                tutorText.textContent = "AI Tutor: Off";
                document.body.classList.remove('tutor-mode-active');
            }
        }

        async function explainCard(term, def) {
            openAIModal(`Explaining: ${term}`);
            const prompt = `Explain the medical concept "${term}" and its association "${def}" simply for a medical student. 
            Be concise (max 3 sentences). 
            Then, provide a creative mnemonic to remember it. Return JSON: { "explanation": "...", "mnemonic": "..." }`;
            
            const raw = await callGemini(prompt, "You are a helpful hematology tutor. Output valid JSON.");
            if (raw) {
                try {
                    const data = JSON.parse(raw);
                    const md = `**Explanation:** ${data.explanation}\n\n**Mnemonic:** ${data.mnemonic}`;
                    displayAIContent(md);
                } catch(e) {
                    displayAIContent(raw); // Fallback if regular text
                }
            } else {
                displayAIContent("Could not retrieve explanation.");
            }
        }

        async function startAICase() {
            gameState = 'ai-case';
            updateUI();
            
            // Pick random term
            const item = FULL_DATA[Math.floor(Math.random() * FULL_DATA.length)];

            // UI Loading
            mainContent.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[60vh] text-center px-4">
                    <div class="relative mb-8">
                        <div class="absolute inset-0 bg-violet-200 rounded-full animate-ping opacity-25"></div>
                        <div class="relative bg-violet-100 text-violet-600 p-6 rounded-full">
                            ${ICONS.Stethoscope}
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Generating Board-Style Question...</h2>
                    <p class="text-slate-500 animate-pulse">Consulting Gemini for a clinical scenario based on: ${item.term}</p>
                </div>
            `;

            // Strict Board-Style Prompt
            const prompt = `Generate a high-yield USMLE Step 1 style clinical vignette for the diagnosis: "${item.term}" (Key Association: ${item.def}).
            
            Structure the JSON response exactly as follows:
            {
              "scenario": "A [Age] year old [Gender] presents with [Chief Complaint]. History reveals [Relevant Hx]. Physical exam shows [Findings]. Labs show [Relevant diagnostic findings]. (Do NOT name the diagnosis)",
              "question": "Which of the following is the most likely diagnosis? OR What is the underlying mechanism? OR What is the next best step? (Choose the most appropriate high-yield question task)",
              "options": ["Option A", "Option B", "Option C", "Option D", "Option E"],
              "correct_option_index": 0, (0-4 indicating the correct option from the list above),
              "explanation": "Brief explanation of why the correct answer is right and why others are wrong, citing specific clues from the scenario."
            }
            
            Ensure the 'options' array contains 5 plausible choices including the correct one. The correct answer should be '${item.term}' or a mechanism directly related to it.
            Require integrated basic science knowledge to find the single best answer.`;

            try {
                const response = await callGemini(prompt, "You are a board exam question writer. Return strict JSON.");
                if (!response) throw new Error("No response");
                
                const data = JSON.parse(response);
                currentCase = data;
                caseAnswered = false;
                renderAICase();
            } catch (e) {
                console.error(e);
                alert("Failed to generate case. Please try again.");
                goToMenu();
            }
        }

        function renderAICase() {
            mainContent.innerHTML = `
                <div class="max-w-3xl mx-auto px-4 py-8 animate-fadeIn">
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                        <!-- Scenario Header -->
                        <div class="bg-violet-600 p-6 text-white">
                            <div class="flex items-center gap-2 mb-3 opacity-90">
                                ${ICONS.Stethoscope.replace('width="24"', 'width="18"')}
                                <span class="text-xs font-bold uppercase tracking-wider">Clinical Vignette</span>
                            </div>
                            <p class="text-lg md:text-xl font-medium leading-relaxed font-serif text-white/95">
                                ${currentCase.scenario}
                            </p>
                        </div>
                        
                        <!-- Question Stem -->
                        <div class="px-6 pt-6 pb-2">
                            <h3 class="text-lg font-bold text-slate-800">${currentCase.question}</h3>
                        </div>

                        <!-- Options -->
                        <div class="p-6 grid grid-cols-1 gap-3">
                            ${currentCase.options.map((opt, idx) => `
                                <button onclick="handleCaseAnswer(${idx})" 
                                    class="case-opt-btn p-4 rounded-xl border-2 border-slate-200 hover:border-violet-400 hover:bg-violet-50 text-left font-medium text-slate-700 transition-all flex items-center gap-3">
                                    <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold flex items-center justify-center shrink-0 border border-slate-200 text-sm">
                                        ${String.fromCharCode(65 + idx)}
                                    </span>
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>

                        <!-- Feedback Section -->
                        <div id="case-feedback" class="hidden p-6 bg-slate-50 border-t border-slate-200">
                            <!-- Feedback injected here -->
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                         <button onclick="startAICase()" class="text-violet-600 font-bold hover:underline">Skip / Next Case</button>
                    </div>
                </div>
            `;
        }

        function handleCaseAnswer(selectedIdx) {
            if (caseAnswered) return;
            caseAnswered = true;
            
            const correctIdx = currentCase.correct_option_index;
            const isCorrect = selectedIdx === correctIdx;
            const feedbackEl = document.getElementById('case-feedback');
            const btns = document.querySelectorAll('.case-opt-btn');

            btns.forEach((btn, idx) => {
                if (idx === correctIdx) {
                    btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                    btn.querySelector('span').classList.add('bg-green-200', 'text-green-800', 'border-green-300');
                } else if (idx === selectedIdx && !isCorrect) {
                    btn.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                    btn.querySelector('span').classList.add('bg-red-200', 'text-red-800', 'border-red-300');
                } else {
                    btn.classList.add('opacity-50');
                }
                btn.disabled = true;
            });

            feedbackEl.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="p-2 rounded-full ${isCorrect ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} shrink-0">
                        ${isCorrect ? ICONS.CheckCircle.replace('width="64"', 'width="24"').replace('height="64"', 'height="24"') : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>'}
                    </div>
                    <div>
                        <h4 class="font-bold text-lg ${isCorrect ? 'text-green-800' : 'text-red-800'} mb-1">
                            ${isCorrect ? 'Correct!' : 'Incorrect'}
                        </h4>
                        <div class="text-slate-600 mb-4 prose prose-sm">
                            ${marked.parse(currentCase.explanation)}
                        </div>
                        <button onclick="startAICase()" class="px-6 py-2 bg-violet-600 hover:bg-violet-700 text-white rounded-lg font-bold shadow-sm transition-all">
                            Next Case ${ICONS.ArrowRight.replace('width="20"', 'width="16"')}
                        </button>
                    </div>
                </div>
            `;
            feedbackEl.classList.remove('hidden');
            feedbackEl.classList.add('animate-popIn');
        }

        // --- AI MODAL LOGIC ---
        function openAIModal(title) {
            aiModal.classList.remove('hidden');
            aiModalTitle.textContent = title;
            aiModalContent.innerHTML = '';
            aiLoading.classList.remove('hidden');
            document.getElementById('ai-modal-footer').classList.add('hidden');
            ttsBtn.classList.add('hidden');
        }

        function closeAIModal() {
            aiModal.classList.add('hidden');
        }

        async function displayAIContent(markdown) {
            aiLoading.classList.add('hidden');
            aiModalContent.innerHTML = marked.parse(markdown);
            document.getElementById('ai-modal-footer').classList.remove('hidden');
            
            // Setup TTS
            const cleanText = markdown.replace(/[#*]/g, ''); // Simple cleanup
            ttsBtn.onclick = async () => {
                ttsBtn.innerHTML = `<svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Loading Audio...`;
                const pcm = await generateTTS(cleanText);
                if (pcm) {
                    playPCM(pcm);
                    ttsBtn.innerHTML = `Playing...`;
                    setTimeout(() => {
                         ttsBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg> Play Again`;
                    }, 2000);
                } else {
                    ttsBtn.innerText = "Error";
                }
            };
            ttsBtn.classList.remove('hidden');
        }


        // --- MATCHING GAME LOGIC ---

        function startGame(catId) {
            selectedCategory = catId;
            let filtered = catId === 'All' ? [...FULL_DATA] : FULL_DATA.filter(item => item.category === catId);
            filtered.sort(() => 0.5 - Math.random());
            deck = filtered.map((item, idx) => ({ ...item, id: `item-${idx}` }));
            
            score = 0;
            mistakes = 0;
            matchedIds = [];
            leftCol = [...deck].sort(() => 0.5 - Math.random());
            rightCol = [...deck].sort(() => 0.5 - Math.random());
            
            gameState = 'playing';
            updateUI();
        }

        function handleLeftClick(id, term, def) {
            if (aiTutorMode) {
                explainCard(term, def);
                return;
            }
            if (matchedIds.includes(id) || wrongPair) return;
            selectedLeft = (selectedLeft === id) ? null : id;
            checkMatch();
            renderBoard();
        }

        function handleRightClick(id, term, def) {
            if (aiTutorMode) {
                explainCard(term, def);
                return;
            }
            if (matchedIds.includes(id) || wrongPair) return;
            selectedRight = (selectedRight === id) ? null : id;
            checkMatch();
            renderBoard();
        }

        function checkMatch() {
            if (!selectedLeft || !selectedRight) return;
            const leftId = selectedLeft;
            const rightId = selectedRight;

            if (leftId === rightId) {
                matchedIds.push(leftId);
                score += 100;
                selectedLeft = null;
                selectedRight = null;
                updateStats();
                if (matchedIds.length === deck.length) setTimeout(renderGameEnd, 800);
            } else {
                wrongPair = { left: leftId, right: rightId };
                mistakes++;
                updateStats();
                renderBoard();
                setTimeout(() => {
                    selectedLeft = null;
                    selectedRight = null;
                    wrongPair = null;
                    renderBoard();
                }, 1000);
            }
        }

        // --- FLOWCHART LOGIC ---

        function startFlowchart() {
            gameState = 'flowchart';
            fcZoom = 0.6; // Adjusted start zoom to see more
            fcPanX = 50;
            fcPanY = 50;
            placedItems = {};
            heldItem = null;
            score = 0;
            updateUI();
        }

        function pickupItem(answer) {
            if (heldItem === answer) {
                heldItem = null;
            } else {
                heldItem = answer;
            }
            renderFlowchart();
        }

        function placeItem(zoneId, correctAnswer) {
            if (!heldItem) return;

            if (heldItem === correctAnswer) {
                placedItems[zoneId] = heldItem;
                heldItem = null;
                score += 50;
                // Check win
                const totalDrops = FLOWCHART_NODES.filter(n => n.type === 'drop').length;
                if (Object.keys(placedItems).length === totalDrops) {
                    setTimeout(() => alert("Flowchart Complete! Great job."), 500);
                }
            } else {
                alert("Incorrect placement. Try again.");
            }
            renderFlowchart();
        }

        function adjustZoom(delta) {
            fcZoom = Math.max(0.4, Math.min(2.0, fcZoom + delta));
            renderFlowchart();
        }
        function resetZoom() {
            fcZoom = 0.6;
            fcPanX = 50;
            fcPanY = 50;
            renderFlowchart();
        }

        function handleChartMouseDown(e) {
            if (e.target.closest('.interactive-el')) return; 
            isDraggingChart = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            const container = document.getElementById('fc-container');
            container.style.cursor = 'grabbing';
        }
        
        function handleChartMouseMove(e) {
            if (!isDraggingChart) return;
            e.preventDefault();
            const dx = e.clientX - lastMouseX;
            const dy = e.clientY - lastMouseY;
            fcPanX += dx;
            fcPanY += dy;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            
            const content = document.getElementById('fc-content');
            content.style.transform = `translate(${fcPanX}px, ${fcPanY}px) scale(${fcZoom})`;
        }

        function handleChartMouseUp() {
            isDraggingChart = false;
            const container = document.getElementById('fc-container');
            if (container) container.style.cursor = 'grab';
        }

        // --- RENDERERS ---

        function goToMenu() {
            gameState = 'menu';
            updateUI();
        }

        function updateUI() {
            aiTutorMode = false; // Reset on mode change
            document.body.classList.remove('tutor-mode-active');
            
            // Set overflow based on mode to enable/disable scrolling
            if (gameState === 'flowchart') {
                mainContent.classList.remove('overflow-y-auto');
                mainContent.classList.add('overflow-hidden');
            } else {
                mainContent.classList.remove('overflow-hidden');
                mainContent.classList.add('overflow-y-auto');
            }

            // Controls Visibility
            if (gameState === 'menu') {
                gameStats.classList.add('hidden');
                closeBtn.classList.add('hidden');
                aiTutorToggle.classList.add('hidden');
                flowchartControls.classList.add('hidden');
            } else {
                closeBtn.classList.remove('hidden');
                
                if (gameState === 'playing') {
                    gameStats.classList.remove('hidden');
                    aiTutorToggle.classList.remove('hidden');
                    flowchartControls.classList.add('hidden');
                    updateStats();
                } else if (gameState === 'flowchart') {
                    gameStats.classList.add('hidden');
                    aiTutorToggle.classList.add('hidden');
                    flowchartControls.classList.remove('hidden');
                } else if (gameState === 'ai-case') {
                     gameStats.classList.add('hidden');
                     aiTutorToggle.classList.add('hidden');
                     flowchartControls.classList.add('hidden');
                }
            }

            // Main Content
            if (gameState === 'menu') renderMenu();
            else if (gameState === 'playing') renderBoard();
            else if (gameState === 'flowchart') renderFlowchart();
            else if (gameState === 'game-end') renderGameEnd();
            else if (gameState === 'ai-case') { /* Render handled by async startAICase */ }
        }

        function updateStats() {
            progressDisplay.textContent = `${matchedIds.length} / ${deck.length}`;
            scoreDisplay.textContent = score;
        }

        function renderMenu() {
            mainContent.classList.remove('bg-slate-200'); // Clean slate
            mainContent.classList.add('px-4', 'py-6', 'max-w-6xl', 'mx-auto'); 
            mainContent.innerHTML = `
                <div class="max-w-4xl mx-auto animate-slideIn">
                    <div class="text-center py-8">
                        <h2 class="text-3xl font-extrabold text-slate-800 mb-2">Select Your Module</h2>
                        <p class="text-slate-500">Structured learning from foundations to clinical application.</p>
                    </div>

                    <!-- AI & Interactive -->
                    <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                         <button onclick="startFlowchart()" class="flex flex-col p-4 bg-white rounded-xl border-2 border-indigo-100 hover:border-indigo-500 shadow-sm hover:shadow-md transition-all group text-left h-full">
                            <div class="p-3 rounded-lg bg-indigo-600 text-white w-fit mb-3 group-hover:scale-110 transition-transform shadow-sm">
                                ${ICONS.GitBranch}
                            </div>
                            <h3 class="font-bold text-slate-700 text-lg">Diagnostic Flowchart</h3>
                            <div class="text-sm font-semibold text-slate-400 mt-1">Interactive Algorithm</div>
                        </button>
                        
                        <button onclick="startAICase()" class="flex flex-col p-4 bg-white rounded-xl border-2 border-violet-100 hover:border-violet-500 shadow-sm hover:shadow-md transition-all group text-left h-full">
                            <div class="p-3 rounded-lg bg-violet-600 text-white w-fit mb-3 group-hover:scale-110 transition-transform shadow-sm">
                                ${ICONS.Sparkles}
                            </div>
                            <h3 class="font-bold text-slate-700 text-lg">AI Clinical Vignettes</h3>
                            <div class="text-sm font-semibold text-slate-400 mt-1">✨ Gemini-Generated Cases</div>
                        </button>
                    </div>
                    
                    ${renderCategoryGroups()}
                </div>
            `;
        }

        function renderCategoryGroups() {
             const GROUPS = [
                { title: "Foundations", items: [
                    { id: 'Foundations: Labs', label: 'Labs & Diagnostics', icon: 'FlaskConical', color: 'bg-blue-500' },
                    { id: 'Foundations: RBC Morphology', label: 'RBC Morphology', icon: 'Droplet', color: 'bg-red-500' }
                ]},
                { title: "Pathology Modules", items: [
                    { id: 'Module: Disease Mechanisms', label: 'Disease: Mechanisms', icon: 'Activity', color: 'bg-purple-600' },
                    { id: 'Module: Disease Labs', label: 'Disease: Lab Findings', icon: 'Layers', color: 'bg-indigo-600' }
                ]},
                { title: "Treatment & Organisms", items: [
                    { id: 'Module: Pharmacology', label: 'Pharmacology', icon: 'Pill', color: 'bg-emerald-600' },
                    { id: 'Module: Parasites', label: 'Parasites & Malaria', icon: 'Bug', color: 'bg-orange-500' }
                ]},
                { title: "Comprehensive", items: [
                    { id: 'All', label: 'Master Exam (All Content)', icon: 'TrophyBig', color: 'bg-slate-800' }
                ]}
            ];

            return GROUPS.map(group => `
                <div class="mb-6">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 px-2">${group.title}</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${group.items.map(cat => {
                             const count = cat.id === 'All' ? FULL_DATA.length : FULL_DATA.filter(i => i.category === cat.id).length;
                             const icon = ICONS[cat.icon] || ICONS.Activity;
                             return `
                                <button onclick="startGame('${cat.id}')" class="flex items-center p-4 bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-blue-300 transition-all group text-left">
                                    <div class="p-3 rounded-lg ${cat.color} text-white mr-4 group-hover:scale-110 transition-transform shadow-sm shrink-0">
                                        ${icon}
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-slate-700">${cat.label}</h3>
                                        <div class="text-xs font-semibold text-slate-400 mt-1 uppercase tracking-wide">
                                            ${count} Cards
                                        </div>
                                    </div>
                                </button>
                             `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        // --- RENDER FLOWCHART ---
        function renderFlowchart() {
            mainContent.classList.remove('px-4', 'max-w-6xl');
            mainContent.classList.add('bg-slate-200'); 
            mainContent.innerHTML = '';

            const bankItems = FLOWCHART_NODES
                .filter(n => n.type === 'drop')
                .map(n => n.answer)
                .filter((v, i, a) => a.indexOf(v) === i)
                .sort();

            const sidebarHTML = `
                <div class="absolute left-4 top-4 bottom-4 w-64 bg-white/90 backdrop-blur rounded-2xl shadow-xl z-20 flex flex-col overflow-hidden border border-slate-200">
                    <div class="p-4 bg-slate-50 border-b border-slate-200">
                        <h3 class="font-bold text-slate-800">Term Bank</h3>
                        <p class="text-xs text-slate-500">Tap to pickup, Tap blank to place</p>
                    </div>
                    <div class="p-2 overflow-y-auto flex-grow space-y-2">
                        ${bankItems.map(term => {
                            const totalNeeded = FLOWCHART_NODES.filter(n => n.answer === term).length;
                            const currentPlaced = Object.values(placedItems).filter(v => v === term).length;
                            const isDone = currentPlaced >= totalNeeded;
                            const isHeld = heldItem === term;

                            return `
                                <button 
                                    onclick="pickupItem('${term}')"
                                    class="w-full text-left p-3 text-sm font-semibold rounded-lg transition-all
                                    ${isDone ? 'bg-slate-100 text-slate-400 line-through' : 
                                      isHeld ? 'bg-blue-600 text-white shadow-lg scale-105 ring-2 ring-blue-300' : 
                                      'bg-white border border-slate-200 hover:bg-blue-50 hover:border-blue-300 text-slate-700 shadow-sm'}
                                    "
                                    ${isDone ? 'disabled' : ''}
                                >
                                    ${term}
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            let chartHTML = '';
            FLOWCHART_NODES.forEach(node => {
                const left = node.x * 200;
                const top = node.y * 100;
                const width = (node.w * 200) - 20; 
                
                let content = '';
                if (node.type === 'label') {
                    content = `
                        <div class="absolute flex items-center justify-center p-2 text-center rounded-xl shadow-sm border-2 font-bold text-slate-700
                                    ${node.color || 'bg-white border-slate-200'}"
                             style="left: ${left}px; top: ${top}px; width: ${width}px; height: 80px;">
                            ${node.text}
                        </div>
                    `;
                } else if (node.type === 'drop') {
                    const isFilled = placedItems[node.id];
                    const isActive = heldItem && !isFilled;
                    content = `
                        <div onclick="placeItem('${node.id}', '${node.answer}')"
                             class="interactive-el absolute flex items-center justify-center p-2 text-center rounded-xl border-2 font-bold text-sm transition-all drop-zone
                                    ${isFilled 
                                        ? (node.isFinal ? 'bg-green-100 border-green-500 text-green-800' : 'bg-blue-100 border-blue-500 text-blue-800')
                                        : 'bg-white border-dashed border-slate-300 text-slate-400 hover:border-blue-400 cursor-pointer'}
                                    ${isActive ? 'animate-pulse bg-blue-50' : ''}"
                             style="left: ${left}px; top: ${top}px; width: ${width}px; height: 80px;">
                            ${isFilled ? isFilled : (isActive ? 'Place Here' : '?')}
                        </div>
                    `;
                }
                chartHTML += content;
            });

            // UPDATED CONNECTOR LINES TO MATCH NEW LAYOUT
            const svgLines = `
                <svg class="absolute top-0 left-0 w-full h-full pointer-events-none" style="z-index: 0;">
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#94a3b8" />
                        </marker>
                    </defs>
                    
                    <!-- Microcytic Branch -->
                    <line x1="600" y1="80" x2="600" y2="200" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- Header to Step 1 -->
                    
                    <!-- Iron Studies to Low/High -->
                    <line x1="600" y1="280" x2="300" y2="350" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- To Low Iron -->
                    <line x1="600" y1="280" x2="900" y2="350" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- To High Iron -->

                    <!-- Low Iron to Ferritin Options -->
                    <line x1="300" y1="430" x2="100" y2="500" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- Low Ferritin -->
                    <line x1="300" y1="430" x2="300" y2="500" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- High Ferritin -->
                    <line x1="300" y1="430" x2="500" y2="500" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- Normal Ferritin -->

                    <!-- High Iron to Sidero -->
                    <line x1="900" y1="430" x2="900" y2="500" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" />

                    <!-- Normocytic Branch -->
                    <line x1="2000" y1="80" x2="2000" y2="200" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- Header to Step 1 -->
                    
                    <!-- Retic Split -->
                    <line x1="2000" y1="280" x2="1300" y2="350" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- <2% -->
                    <line x1="2000" y1="280" x2="2200" y2="350" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- >2% -->

                    <!-- <2% to Pancyto -->
                    <line x1="1300" y1="430" x2="1100" y2="500" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" />
                    <line x1="1300" y1="430" x2="1300" y2="500" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" />

                    <!-- >2% to Inherited/Acquired -->
                    <line x1="2200" y1="430" x2="1900" y2="500" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- Inherited -->
                    <line x1="2200" y1="430" x2="2400" y2="500" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- Acquired -->

                    <!-- Inherited Split -->
                    <line x1="1900" y1="580" x2="1600" y2="650" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" />
                    <line x1="1900" y1="580" x2="1800" y2="650" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" />

                    <!-- Acquired Split (Coombs) -->
                    <line x1="2400" y1="580" x2="2100" y2="650" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- Positive -->
                    <line x1="2400" y1="580" x2="2500" y2="650" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- Negative -->

                    <!-- Coombs Pos Split -->
                    <line x1="2100" y1="730" x2="2000" y2="800" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" />
                    <line x1="2100" y1="730" x2="2200" y2="800" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" />

                    <!-- Coombs Neg Split (CD55) -->
                    <line x1="2500" y1="730" x2="2500" y2="800" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" />
                    <line x1="2500" y1="880" x2="2350" y2="950" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- PNH -->
                    <line x1="2500" y1="880" x2="2650" y2="950" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- TTP -->


                    <!-- Macrocytic Branch -->
                    <line x1="3200" y1="80" x2="3200" y2="200" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- Header to Step 1 -->
                    <line x1="3200" y1="280" x2="3200" y2="350" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- To Megalo check -->
                    <line x1="3200" y1="430" x2="3200" y2="500" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- To Copper -->

                    <!-- Copper Split -->
                    <line x1="3200" y1="580" x2="2800" y2="650" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- Low Copper -->
                    <line x1="3200" y1="580" x2="3400" y2="650" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" /> <!-- Normal Copper -->

                    <!-- Normal Copper to B12/Folate -->
                    <line x1="3400" y1="730" x2="3100" y2="800" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" />
                    <line x1="3400" y1="730" x2="3400" y2="800" stroke="#cbd5e1" stroke-width="2" marker-end="url(#arrow)" />

                </svg>
            `;

            mainContent.innerHTML = `
                ${sidebarHTML}
                <div id="fc-container" class="w-full h-full overflow-hidden relative flowchart-container"
                     onmousedown="handleChartMouseDown(event)"
                     onmousemove="handleChartMouseMove(event)"
                     onmouseup="handleChartMouseUp()"
                     onmouseleave="handleChartMouseUp()">
                     
                    <div id="fc-content" style="transform: translate(${fcPanX}px, ${fcPanY}px) scale(${fcZoom}); width: 4000px; height: 2000px; position: relative;">
                        ${svgLines}
                        ${chartHTML}
                    </div>
                </div>
            `;
        }

        function renderBoard() {
             mainContent.classList.remove('bg-slate-200'); 
             mainContent.classList.add('px-4', 'max-w-6xl', 'mx-auto'); 
             
             // AI Tutor Notice
             const tutorNotice = aiTutorMode 
                ? `<div class="bg-violet-100 border border-violet-200 text-violet-800 px-4 py-2 rounded-lg mb-4 text-center font-medium animate-fadeIn">✨ AI Tutor Active: Click any card to get an explanation & mnemonic!</div>`
                : ``;

            let html = `
                <div class="animate-fadeIn pb-12">
                    ${tutorNotice}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-12 relative">
                        
                        <!-- LEFT COL -->
                        <div class="flex flex-col gap-3">
                            <h3 class="text-slate-400 font-bold uppercase text-xs tracking-wider mb-2 text-center md:text-left sticky top-0 bg-slate-50 py-2 z-10">Terms / Disease</h3>
            `;

            leftCol.forEach(item => {
                const isMatched = matchedIds.includes(item.id);
                const isSelected = selectedLeft === item.id;
                const isError = wrongPair?.left === item.id;
                
                let btnClass = "card-btn w-full text-left p-4 rounded-xl border-2 transition-all relative flex items-center justify-between min-h-[4rem] ";
                let textClass = "font-bold text-sm md:text-base ";

                if (isMatched) {
                    btnClass += "bg-slate-50 border-slate-100 text-slate-300 opacity-50 cursor-default";
                    textClass += "line-through";
                } else if (isError) {
                    btnClass += "bg-red-50 border-red-500 animate-shake z-10";
                    textClass += "text-slate-800";
                } else if (isSelected) {
                    btnClass += "bg-blue-50 border-blue-500 shadow-md z-10";
                    textClass += "text-slate-800";
                } else {
                    btnClass += "bg-white border-slate-200 hover:border-blue-300 hover:shadow-sm";
                    textClass += "text-slate-800";
                }

                html += `
                    <button onclick="handleLeftClick('${item.id}', '${item.term}', '${item.def}')" ${isMatched ? 'disabled' : ''} class="${btnClass}">
                        <span class="${textClass}">${item.term}</span>
                        ${isSelected ? '<div class="w-3 h-3 bg-blue-500 rounded-full selected-pulse"></div>' : ''}
                        ${aiTutorMode ? `<span class="absolute right-2 top-2 text-violet-400 opacity-50">✨</span>` : ''}
                    </button>
                `;
            });

            html += `</div>`; // End Left Col

            html += `<div class="hidden md:block absolute left-1/2 top-10 bottom-4 w-px bg-slate-200 -translate-x-1/2"></div>`;

            // RIGHT COL
            html += `<div class="flex flex-col gap-3">
                        <h3 class="text-slate-400 font-bold uppercase text-xs tracking-wider mb-2 text-center md:text-left sticky top-0 bg-slate-50 py-2 z-10">Mechanism / Findings</h3>`;

            rightCol.forEach(item => {
                const isMatched = matchedIds.includes(item.id);
                const isSelected = selectedRight === item.id;
                const isError = wrongPair?.right === item.id;

                let btnClass = "card-btn w-full text-left p-4 rounded-xl border-2 transition-all min-h-[4rem] flex items-center ";
                let textClass = "text-sm leading-snug ";

                if (isMatched) {
                    btnClass += "bg-slate-50 border-slate-100 text-slate-300 opacity-50 cursor-default";
                    textClass += "line-through";
                } else if (isError) {
                    btnClass += "bg-red-50 border-red-500 animate-shake z-10";
                    textClass += "text-slate-600 font-medium";
                } else if (isSelected) {
                    btnClass += "bg-blue-50 border-blue-500 shadow-md z-10";
                    textClass += "text-slate-600 font-medium";
                } else {
                    btnClass += "bg-white border-slate-200 hover:border-blue-300 hover:shadow-sm";
                    textClass += "text-slate-600 font-medium";
                }

                html += `
                    <button onclick="handleRightClick('${item.id}', '${item.term}', '${item.def}')" ${isMatched ? 'disabled' : ''} class="${btnClass}">
                        <span class="${textClass}">${item.def}</span>
                         ${aiTutorMode ? `<span class="absolute right-2 top-2 text-violet-400 opacity-50">✨</span>` : ''}
                    </button>
                `;
            });

            html += `</div></div></div>`;
            mainContent.innerHTML = html;
        }

        function renderGameEnd() {
            mainContent.classList.remove('bg-slate-200'); 
            mainContent.classList.add('px-4', 'max-w-6xl', 'mx-auto'); 
            
            mainContent.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[60vh] animate-popIn">
                    <div class="bg-yellow-100 text-yellow-600 p-6 rounded-full mb-6">
                        ${ICONS.TrophyBig}
                    </div>
                    <h2 class="text-4xl font-extrabold text-slate-800 mb-4">Module Complete!</h2>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 w-full max-w-sm mb-8">
                        <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-4">
                            <span class="text-slate-500 font-medium">Final Score</span>
                            <span class="text-2xl font-bold text-blue-600">${score}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500 font-medium">Mistakes</span>
                            <span class="text-2xl font-bold ${mistakes === 0 ? 'text-green-500' : 'text-red-500'}">
                                ${mistakes}
                            </span>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="goToMenu()" class="px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-xl font-bold transition-colors">
                            Back to Menu
                        </button>
                        <button onclick="startGame('${selectedCategory}')" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-colors flex items-center gap-2">
                            ${ICONS.RotateCcw} Replay
                        </button>
                    </div>
                </div>
            `;
        }

        // Initialize the app
        init();

    </script>
</body>
</html>
